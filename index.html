<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SD Premium ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{--bg:#070507;--card:#0f0e10;--muted:#9b98a3;--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);--ok:#10b981;font-family:Inter}
body{margin:0;background:var(--bg);color:#fff;padding:20px}
.wrap{max-width:1200px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.logo{width:52px;height:52px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
.grid{display:grid;grid-template-columns:320px 1fr;gap:14px}
.panel{background:var(--card);border-radius:12px;padding:14px}
.ticket{padding:10px;border-radius:10px;background:rgba(255,255,255,.03);margin-bottom:8px;cursor:pointer}
.btn{background:var(--accent);border:0;color:#fff;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
.btn.secondary{background:#151319}
.small{color:var(--muted);font-size:13px}
.staff{color:var(--ok);font-weight:700}
.comment{background:rgba(255,255,255,.05);padding:8px;border-radius:8px;margin-bottom:6px}
img.avatar{width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:6px}
select{background:#141217;color:#fff;border:1px solid rgba(255,255,255,.1);border-radius:6px;padding:4px}
</style>
</head>
<body>

<div class="wrap">
<div class="top">
<div style="display:flex;gap:10px;align-items:center">
<div class="logo">SD</div>
<b>–ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</b>
</div>
<div>
<button id="loginBtn" class="btn secondary">–í–æ–π—Ç–∏</button>
<button id="logoutBtn" class="btn secondary" style="display:none">–í—ã–π—Ç–∏</button>
</div>
</div>

<div class="grid">
<div class="panel">
<input id="search" placeholder="–ü–æ–∏—Å–∫..." style="width:100%;margin-bottom:10px">
<div id="tickets"></div>
</div>

<div class="panel">
<div id="empty">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div>
<div id="view" style="display:none">
<h3 id="tTitle"></h3>
<div class="small" id="tMeta"></div>
<div id="tDesc" style="margin:10px 0"></div>

<label>–°—Ç–∞—Ç—É—Å:
<select id="statusSelect">
<option>–í —Ä–∞–±–æ—Ç–µ</option>
<option>–†–µ—à–µ–Ω–∞</option>
<option>–ê—Ä—Ö–∏–≤</option>
</select>
</label>

<h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>
<div id="comments"></div>

<textarea id="replyText" placeholder="–û—Ç–≤–µ—Ç..." style="width:100%;min-height:80px"></textarea>
<input type="file" id="replyFile">

<div style="margin-top:8px;display:flex;gap:8px">
<button id="sendReply" class="btn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
<button id="deleteBtn" class="btn secondary">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>
</div>
</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
authDomain:"sd-premium-b3b78.firebaseapp.com",
projectId:"sd-premium-b3b78"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const ticketsEl=document.getElementById('tickets');
const view=document.getElementById('view');
const empty=document.getElementById('empty');
const tTitle=document.getElementById('tTitle');
const tMeta=document.getElementById('tMeta');
const tDesc=document.getElementById('tDesc');
const commentsEl=document.getElementById('comments');
const replyText=document.getElementById('replyText');
const replyFile=document.getElementById('replyFile');
const sendReply=document.getElementById('sendReply');
const deleteBtn=document.getElementById('deleteBtn');
const statusSelect=document.getElementById('statusSelect');
const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');

let currentUser=null;
let currentDoc=null;
let selectedTicket=null;

loginBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async u=>{
currentUser=u;
if(u){
loginBtn.style.display='none';
logoutBtn.style.display='inline-block';
const d=await db.collection('users').doc(u.uid).get();
currentDoc=d.data();
if(!currentDoc?.isStaff){alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞");return;}
loadTickets();
}else{
loginBtn.style.display='inline-block';
logoutBtn.style.display='none';
}
});

async function loadTickets(){
ticketsEl.innerHTML='';
const users=await db.collection('users').get();
for(const u of users.docs){
const snap=await db.collection('users').doc(u.id).collection('tickets').get();
snap.forEach(doc=>{
const t=doc.data();
const div=document.createElement('div');
div.className='ticket';
div.innerHTML=`<b>${t.subject}</b><div class="small">${t.userName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ¬∑ ${t.status||'–í —Ä–∞–±–æ—Ç–µ'}</div>`;
div.onclick=()=>openTicket(doc.id,u.id,t);
ticketsEl.appendChild(div);
});
}
}

function openTicket(id,uid,data){
selectedTicket={id,uid};
view.style.display='block';
empty.style.display='none';
tTitle.textContent=data.subject;
tDesc.textContent=data.desc;
tMeta.textContent=data.userName;
statusSelect.value=data.status||'–í —Ä–∞–±–æ—Ç–µ';
renderComments(data.comments||[]);
}

function renderComments(arr){
commentsEl.innerHTML='';
arr.forEach(c=>{
const d=document.createElement('div');
d.className='comment';
d.innerHTML=`
<div class="small">
${c.avatar?`<img src="${c.avatar}" class="avatar">`:''}
${c.byName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${c.role==='staff'?'<span class="staff">(–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏)</span>':''}
</div>
<div>${c.text}</div>
${c.file?`<a href="${c.file}" target="_blank">üìé –í–ª–æ–∂–µ–Ω–∏–µ</a>`:''}
`;
commentsEl.appendChild(d);
});
}

sendReply.onclick=async()=>{
if(!selectedTicket)return;
let fileData=null;
if(replyFile.files[0]){
const r=new FileReader();
r.onload=async()=>{
fileData=r.result;
await sendComment(fileData);
};
r.readAsDataURL(replyFile.files[0]);
}else{
await sendComment(null);
}
};

async function sendComment(file){
const ref=db.collection('users').doc(selectedTicket.uid).collection('tickets').doc(selectedTicket.id);
const snap=await ref.get();
const t=snap.data();
const c={
text:replyText.value,
at:new Date().toISOString(),
byName:currentDoc.name,
avatar:currentDoc.avatar||null,
role:'staff',
file:file
};
await ref.update({
comments:firebase.firestore.FieldValue.arrayUnion(c),
status:statusSelect.value
});
replyText.value='';
replyFile.value='';
loadTickets();
openTicket(selectedTicket.id,selectedTicket.uid,(await ref.get()).data());
}

deleteBtn.onclick=async()=>{
if(!confirm("–£–¥–∞–ª–∏—Ç—å?"))return;
await db.collection('users').doc(selectedTicket.uid).collection('tickets').doc(selectedTicket.id).delete();
view.style.display='none';
empty.style.display='block';
loadTickets();
};

statusSelect.onchange=async()=>{
const ref=db.collection('users').doc(selectedTicket.uid).collection('tickets').doc(selectedTicket.id);
await ref.update({status:statusSelect.value});
loadTickets();
};
</script>
</body>
</html>
