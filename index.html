<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>SD Premium ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
--bg:#070507;--card:#0f0e10;--muted:#9b98a3;
--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);
--radius:14px;--shadow:0 6px 30px rgba(0,0,0,.6);
--green:#22c55e;--red:#ef4444;--blue:#3b82f6;
font-family:Inter;color-scheme:dark;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;padding:24px}
.wrap{max-width:1200px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.logo{width:52px;height:52px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}

.staff-box{
padding:6px 14px;
border-radius:999px;
background:rgba(255,255,255,.05);
border:1px solid rgba(255,255,255,.12);
font-weight:600;
}

.panel{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px}
.grid{
display:grid;
grid-template-columns:340px 1fr;
gap:16px;
align-items:flex-start;
}


.ticket{padding:12px;border-radius:10px;background:rgba(255,255,255,.03);margin-bottom:8px;cursor:pointer;border:1px solid transparent}
.ticket.active{border:1px solid #8b5cf6}
.ticket.new{border-left:4px solid #22c55e}
.ticket h4{margin:0 0 4px 0}

.small{font-size:13px;color:var(--muted)}
.btn{background:var(--accent);border:0;color:#fff;padding:8px 14px;border-radius:10px;font-weight:600;cursor:pointer}
.btn.red{background:#ef4444}
.btn.blue{background:#3b82f6}
.btn.gray{background:#151319;border:1px solid rgba(255,255,255,.08)}

input,textarea,select{background:#141217;border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:8px;padding:8px;width:100%}

.comment{background:rgba(255,255,255,.04);padding:8px;border-radius:8px;margin-bottom:6px}
.staff{color:#22c55e;font-weight:700}

.attach img{max-width:180px;border-radius:8px;margin-top:6px;display:block}

.toast{
position:fixed;top:20px;right:20px;
background:#111216;padding:12px 16px;
border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.6);
z-index:999;color:#fff
}

.counter{
background:#ef4444;
border-radius:999px;
padding:2px 8px;
font-size:12px;
margin-left:6px
}



.panel.tickets-panel{
border:1px solid #8b5cf6;
}

.tickets-panel{
max-height:calc(100vh - 140px);
overflow-y:auto;
}
.chat-panel{
border:1px solid #8b5cf6;
max-height:calc(100vh - 140px);
overflow-y:auto;
}

.chat-panel textarea{
margin-top:8px;
}
.modal-backdrop{
position:fixed;
inset:0;
background:rgba(0,0,0,.45);
backdrop-filter:blur(8px);
-webkit-backdrop-filter:blur(8px);
display:none;
align-items:center;
justify-content:center;
z-index:1000;
}

.auth-panel{
width:100%;
max-width:380px;
border:1px solid rgba(255,255,255,.12);
}

.auth-panel h3{
margin-top:0;
text-align:center;
}

.auth-panel input{
margin-bottom:10px;
}

.auth-panel button{
width:100%;
margin-top:8px;
}
.user-box{
display:flex;
align-items:center;
gap:10px;
}

.avatar{
width:36px;
height:36px;
border-radius:50%;
background:linear-gradient(135deg,#8b5cf6,#06b6d4);
display:flex;
align-items:center;
justify-content:center;
font-weight:700;
color:#fff;
text-transform:uppercase;
}
            
</style>
</head>
<body>

<div class="wrap">
<div class="top">
<div style="display:flex;gap:12px;align-items:center">
<div class="logo">SD</div>
<div><b>SD Premium</b><div class="small">–ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div></div>
</div>
<div class="user-box">
<div class="avatar" id="avatar">?</div>
<div id="staffName" class="staff-box">–ì–æ—Å—Ç—å</div>
<button id="logoutBtn" class="btn gray" style="display:none">–í—ã–π—Ç–∏</button>
</div>
</div>

<div class="grid">
<div class="panel tickets-panel">
<div style="display:flex;gap:8px;margin-bottom:8px">
<select id="statusFilter">
<option value="all">–í—Å–µ</option>
<option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
<option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
<option value="–†–µ—à–µ–Ω–∞">–†–µ—à–µ–Ω–∞</option>
<option value="–ê—Ä—Ö–∏–≤">–ê—Ä—Ö–∏–≤</option>
</select>
<button id="refreshBtn" class="btn gray">–û–±–Ω–æ–≤–∏—Ç—å <span id="unreadCount" class="counter" style="display:none">0</span></button>
</div>
<div id="ticketsList"></div>
</div>

<div class="panel chat-panel">
<div id="empty"><div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div></div>

<div id="ticketView" style="display:none">

<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h3 id="tvTitle"></h3>
<div class="small" id="tvUser"></div>
<div class="small" id="tvMeta"></div>
</div>
<div style="display:flex;gap:6px">
<select id="statusSelect">
<option>–ù–æ–≤–∞—è</option>
<option>–í —Ä–∞–±–æ—Ç–µ</option>
<option>–†–µ—à–µ–Ω–∞</option>
<option>–ê—Ä—Ö–∏–≤</option>
</select>
<button id="saveStatusBtn" class="btn blue">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
<button id="deleteBtn" class="btn red">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>

<div style="margin-top:12px">
<b>–û–ø–∏—Å–∞–Ω–∏–µ</b>
<div id="tvDesc" style="margin-top:6px"></div>
</div>

<div style="margin-top:12px">
<b>–í–ª–æ–∂–µ–Ω–∏—è</b>
<div id="tvAttach"></div>
</div>

<div style="margin-top:12px">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</b>
<div id="tvComments"></div>
</div>

<textarea id="replyText" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..."></textarea>
<button id="sendReply" class="btn" style="margin-top:8px">–û—Ç–≤–µ—Ç–∏—Ç—å</button>

</div>
</div>
</div>

<div class="modal-backdrop" id="authModal">
<div class="panel auth-panel">
<h3>–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ SD Premium</h3>
<input id="email" placeholder="Email">
<input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button id="doLogin" class="btn">–í–æ–π—Ç–∏</button>
</div>
</div>


<script>
const firebaseConfig={
apiKey:"AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
authDomain:"sd-premium-b3b78.firebaseapp.com",
projectId:"sd-premium-b3b78"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const ticketsList=document.getElementById("ticketsList");
const ticketView=document.getElementById("ticketView");
const empty=document.getElementById("empty");

const tvTitle=document.getElementById("tvTitle");
const tvUser=document.getElementById("tvUser");
const tvMeta=document.getElementById("tvMeta");
const tvDesc=document.getElementById("tvDesc");
const tvComments=document.getElementById("tvComments");
const tvAttach=document.getElementById("tvAttach");

const replyText=document.getElementById("replyText");
const sendReply=document.getElementById("sendReply");
const statusSelect=document.getElementById("statusSelect");
const saveStatusBtn=document.getElementById("saveStatusBtn");
const deleteBtn=document.getElementById("deleteBtn");

const authModal=document.getElementById("authModal");
const logoutBtn=document.getElementById("logoutBtn");
const staffName=document.getElementById("staffName");

const refreshBtn=document.getElementById("refreshBtn");
const unreadCount=document.getElementById("unreadCount");
const statusFilter=document.getElementById("statusFilter");

const email=document.getElementById("email");
const pass=document.getElementById("pass");
const doLogin=document.getElementById("doLogin");

let currentTicket=null;
let activeEl=null;
let lastOpenedTicketId=null;

function toast(t){
const d=document.createElement("div");
d.className="toast";
d.textContent=t;
document.body.appendChild(d);
setTimeout(()=>d.remove(),3000);
}

doLogin.onclick=()=>auth.signInWithEmailAndPassword(email.value,pass.value);
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async u=>{
if(u){
logoutBtn.style.display="inline-block";
authModal.style.display="none";

const doc = await db.collection("users").doc(u.uid).get();
const name = doc.exists ? doc.data().name : u.email;
staffName.textContent = name;
avatar.textContent = name[0] || "?";
loadTickets();
}else{
logoutBtn.style.display="none";
authModal.style.display="flex";
ticketsList.innerHTML="";
staffName.textContent = "–ì–æ—Å—Ç—å";
avatar.textContent = "?";
}
});


refreshBtn.onclick=()=>loadTickets();
statusFilter.onchange=()=>loadTickets();

function isImage(url){
return url.startsWith("data:image") || url.match(/\.(png|jpg|jpeg|gif|webp)$/i);
}

function loadTickets(){
ticketsList.innerHTML="";
let unread=0;
db.collection("users").onSnapshot(async users=>{
ticketsList.innerHTML="";
for(const u of users.docs){
const uname=u.data().name||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
const snap=await db.collection("users").doc(u.id).collection("tickets").orderBy("createdAt","desc").get();
snap.forEach(d=>{
const t=d.data();
if(statusFilter.value!=="all" && t.status!==statusFilter.value) return;

if(t.lastReplyRole==="user") unread++;

const div=document.createElement("div");
div.className="ticket "+(t.lastReplyRole==="user"?"new":"");
div.innerHTML=`<h4>${t.subject}</h4><div class="small">${uname} ¬∑ ${t.status||""}</div>`;
div.onclick=()=>{
if(activeEl) activeEl.classList.remove("active");
div.classList.add("active");
activeEl=div;
openTicket(u.id,d.id,t,uname);
};
ticketsList.appendChild(div);
});
}
unreadCount.style.display=unread? "inline-block":"none";
unreadCount.textContent=unread;

if(lastOpenedTicketId) reloadOpenTicket();
});
}

async function reloadOpenTicket(){
const uid=currentTicket?.uid;
const id=currentTicket?.id;
if(!uid||!id) return;
const doc=await db.collection("users").doc(uid).collection("tickets").doc(id).get();
if(doc.exists){
openTicket(uid,id,doc.data(),tvUser.textContent.replace("–û—Ç: ",""));
}
}

function openTicket(uid,id,t,uname){
currentTicket={uid,id};
lastOpenedTicketId=id;
ticketView.style.display="block";
empty.style.display="none";

tvTitle.textContent=t.subject;
tvUser.textContent="–û—Ç: "+uname;
tvMeta.textContent=t.status;
tvDesc.textContent=t.desc;
statusSelect.value=t.status||"–ù–æ–≤–∞—è";

tvComments.innerHTML="";
(t.comments||[]).forEach(c=>{
const div=document.createElement("div");
div.className="comment";
div.innerHTML=`<div class="small">${c.byName||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"} ${c.role==="staff"?"<span class='staff'>(–ø–æ–¥–¥–µ—Ä–∂–∫–∞)</span>":""} ¬∑ ${new Date(c.at).toLocaleString()}</div><div>${c.text}</div>`;
tvComments.appendChild(div);
});

tvAttach.innerHTML="";
(t.attachments||[]).forEach(a=>{
const url=a.url||a.data;
const d=document.createElement("div");
d.className="attach";
if(isImage(url)){
d.innerHTML=`<img src="${url}">`;
}else{
d.innerHTML=`üìé <a href="${url}" target="_blank">${a.name}</a>`;
}
tvAttach.appendChild(d);
});
}

sendReply.onclick=async()=>{
if(!currentTicket) return;
const text=replyText.value.trim();
if(!text) return;
await db.collection("users").doc(currentTicket.uid).collection("tickets").doc(currentTicket.id).update({
comments:firebase.firestore.FieldValue.arrayUnion({
text,
at:new Date().toISOString(),
role:"staff",
byName:staffName.textContent
}),
lastReplyRole:"staff",
status:"–í —Ä–∞–±–æ—Ç–µ"
});
replyText.value="";
toast("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
};

saveStatusBtn.onclick=async()=>{
if(!currentTicket) return;
await db.collection("users").doc(currentTicket.uid).collection("tickets").doc(currentTicket.id).update({
status:statusSelect.value
});
toast("–°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
};

deleteBtn.onclick=async()=>{
if(!currentTicket) return;
if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?"))return;
await db.collection("users").doc(currentTicket.uid).collection("tickets").doc(currentTicket.id).delete();
ticketView.style.display="none";
empty.style.display="block";
toast("–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞");
};
</script>
</body>
</html>
