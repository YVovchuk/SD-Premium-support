<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>SD Premium — Поддержка</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
body{margin:0;font-family:Inter;background:#070507;color:#fff}
.container{padding:20px;transition:.2s}
.container.blurred{filter:blur(6px) brightness(.7)}
.ticket{background:#111;padding:12px;border-radius:10px;margin-bottom:10px}
.comment{background:#1a1a1a;padding:8px;border-radius:8px;margin:6px 0}
.staff{color:#22c55e;font-weight:bold}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7)}
.box{background:#0f0f12;padding:20px;border-radius:12px;width:320px}
input,textarea{width:100%;margin-bottom:10px;padding:8px;border-radius:6px;border:0}
button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
</style>
</head>
<body>

<div class="container" id="main">
<h2>Заявки пользователей</h2>
<div id="tickets"></div>
</div>

<div class="modal" id="authModal">
<div class="box">
<h3 id="authTitle">Вход</h3>
<input id="authName" placeholder="Имя">
<input id="authEmail" placeholder="Email">
<input id="authPass" type="password" placeholder="Пароль">
<button id="loginBtn">Войти</button>
<button id="regBtn">Регистрация</button>
</div>
</div>

<script>
const firebaseConfig = {
 apiKey: "AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
 authDomain: "sd-premium-b3b78.firebaseapp.com",
 projectId: "sd-premium-b3b78",
 storageBucket: "sd-premium-b3b78.firebasestorage.app",
 messagingSenderId: "475471999638",
 appId: "1:475471999638:web:360d369103612e96f6c8b7"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const authModal=document.getElementById('authModal');
const main=document.getElementById('main');
const ticketsDiv=document.getElementById('tickets');

loginBtn.onclick=async()=>{
 const email=authEmail.value;
 const pass=authPass.value;
 await auth.signInWithEmailAndPassword(email,pass);
}
regBtn.onclick=async()=>{
 const name=authName.value;
 const email=authEmail.value;
 const pass=authPass.value;
 const cred=await auth.createUserWithEmailAndPassword(email,pass);
 await db.collection('users').doc(cred.user.uid).set({
   name:name,
   isStaff:true
 });
}

auth.onAuthStateChanged(async user=>{
 if(!user){
   authModal.style.display='flex';
   main.classList.add('blurred');
   return;
 }
 const doc=await db.collection('users').doc(user.uid).get();
 if(!doc.exists||doc.data().isStaff!==true){
   document.body.innerHTML="<h2>Доступ запрещён: ваш аккаунт не помечен как сотрудник</h2>";
   return;
 }
 authModal.style.display='none';
 main.classList.remove('blurred');
 loadTickets();
});

async function loadTickets(){
 ticketsDiv.innerHTML='';
 const map=new Map();

 const root=await db.collection('tickets').get();
 root.forEach(d=>map.set(d.ref.path,{id:d.id,...d.data(),ref:d.ref}));

 const group=await db.collectionGroup('tickets').get();
 group.forEach(d=>{
   if(!map.has(d.ref.path)) map.set(d.ref.path,{id:d.id,...d.data(),ref:d.ref});
 });

 const arr=[...map.values()];
 arr.sort((a,b)=>{
   const ta=a.createdAt?.toDate?.()||new Date(a.createdAt||0);
   const tb=b.createdAt?.toDate?.()||new Date(b.createdAt||0);
   return tb-ta;
 });

 arr.forEach(t=>{
   const div=document.createElement('div');
   div.className='ticket';
   div.innerHTML=`
<b>${t.subject}</b><br>
${t.desc}<br>
<div id="c${t.id}"></div>
<textarea id="r${t.id}" placeholder="Ответ поддержки"></textarea>
<button onclick="reply('${t.ref.path}','${t.id}')">Ответить</button>
`;
   ticketsDiv.appendChild(div);
   renderComments(t.id,t.comments||[]);
 });
}

function renderComments(id,arr){
 const c=document.getElementById('c'+id);
 c.innerHTML='';
 arr.forEach(x=>{
   const d=document.createElement('div');
   d.className='comment';
   d.innerHTML=`<span class="staff">${x.author} (Сотрудник поддержки)</span><br>${x.text}`;
   c.appendChild(d);
 });
}

async function reply(path,id){
 const txt=document.getElementById('r'+id).value;
 if(!txt) return;
 const user=auth.currentUser;
 const u=await db.collection('users').doc(user.uid).get();
 const name=u.data().name||'Сотрудник';
 const ref=db.doc(path);
 await ref.update({
   comments:firebase.firestore.FieldValue.arrayUnion({
     text:txt,
     at:new Date().toISOString(),
     author:name,
     staff:true
   })
 });
 loadTickets();
}
</script>
</body>
</html>
