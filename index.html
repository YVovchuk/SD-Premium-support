<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>SD Premium — Панель поддержки</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
body{margin:0;background:#070507;color:#fff;font-family:Inter}
header{padding:16px 24px;background:#0f0e10;display:flex;justify-content:space-between;align-items:center}
main{display:grid;grid-template-columns:320px 1fr;height:calc(100vh - 64px)}
aside{border-right:1px solid #222;padding:12px;overflow:auto}
.ticket{padding:10px;border-radius:10px;background:#141217;margin-bottom:8px;cursor:pointer}
.ticket:hover{background:#1b1a1d}
section{padding:20px;overflow:auto}
.comment{padding:10px;border-radius:10px;margin-bottom:8px;background:#141217}
.comment.staff{border-left:4px solid #10b981}
.small{color:#9b98a3;font-size:13px}
input,textarea,button{background:#141217;border:1px solid #333;color:#fff;border-radius:8px;padding:8px}
button{cursor:pointer}
.staff-label{color:#10b981;font-weight:600;margin-left:6px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center}
.modal>div{background:#0f0e10;padding:20px;border-radius:12px;width:320px}
.empty{color:#9b98a3;padding:12px}
.error{color:#ff7b7b;padding:12px}
</style>
</head>
<body>

<header>
  <div><b>SD Premium</b> — Поддержка</div>
  <div>
    <span id="staffName"></span>
    <button id="logoutBtn">Выйти</button>
  </div>
</header>

<main>
  <aside id="ticketsList"><div class="empty">Загрузка...</div></aside>
  <section>
    <h2 id="detailTitle">Выберите заявку</h2>
    <div id="detailMeta" class="small"></div>
    <p id="detailDesc"></p>

    <h3>Комментарии</h3>
    <div id="detailComments"></div>

    <textarea id="replyText" placeholder="Ответить..." style="width:100%;min-height:80px"></textarea><br><br>
    <button id="replyBtn">Отправить ответ</button>
  </section>
</main>

<!-- LOGIN -->
<div class="modal" id="loginModal">
  <div>
    <h3>Вход сотрудника</h3>
    <input id="loginEmail" placeholder="Email" style="width:100%"><br><br>
    <input id="loginPassword" type="password" placeholder="Пароль" style="width:100%"><br><br>
    <button id="loginBtn">Войти</button>
    <div class="small" style="margin-top:10px">Если вы — не сотрудник, доступ будет запрещён.</div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
  authDomain: "sd-premium-b3b78.firebaseapp.com",
  projectId: "sd-premium-b3b78"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ====== UI refs ====== */
const ticketsList = document.getElementById('ticketsList');
const detailTitle = document.getElementById('detailTitle');
const detailMeta = document.getElementById('detailMeta');
const detailDesc = document.getElementById('detailDesc');
const detailComments = document.getElementById('detailComments');
const replyText = document.getElementById('replyText');
const replyBtn = document.getElementById('replyBtn');
const staffName = document.getElementById('staffName');
const logoutBtn = document.getElementById('logoutBtn');

const loginModal = document.getElementById('loginModal');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');

let currentUser = null;
let currentTicketDocRef = null; // DocumentReference for selected ticket

/* ====== helpers ====== */
function formatDate(ts){
  if(!ts) return '';
  if(ts.toDate) return ts.toDate().toLocaleString();
  try { return new Date(ts).toLocaleString(); } catch(e) { return String(ts); }
}
function showLogin(){ loginModal.style.display='flex'; }
function hideLogin(){ loginModal.style.display='none'; }

/* ====== auth ====== */
loginBtn.onclick = async ()=>{
  try{
    await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPassword.value);
  }catch(e){
    alert('Ошибка входа: '+e.message);
    console.error(e);
  }
};
logoutBtn.onclick = ()=>auth.signOut();

/* ====== on auth ====== */
auth.onAuthStateChanged(async user=>{
  if(!user){
    currentUser = null;
    staffName.textContent = '';
    showLogin();
    ticketsList.innerHTML = '<div class="empty">Войдите чтобы просматривать заявки</div>';
    return;
  }

  try{
    const udoc = await db.collection('users').doc(user.uid).get();
    const udata = udoc.exists ? udoc.data() : {};
    if(!udata.isStaff){
      alert('Доступ запрещён: ваш аккаунт не помечен как сотрудник (users/{uid}.isStaff ≠ true).');
      await auth.signOut();
      return;
    }
    currentUser = user;
    staffName.textContent = udata.name || user.email || 'Сотрудник';
    hideLogin();
    await loadTickets();
  }catch(e){
    console.error('auth.onAuthStateChanged error', e);
    ticketsList.innerHTML = '<div class="error">Ошибка при проверке аккаунта. Смотрите консоль.</div>';
  }
});

/* ====== robust loadTickets ======
Attempts:
  1) collectionGroup('tickets') (subcollections under users/.../tickets)
  2) root collection 'tickets'
Handles permission-denied with friendly message.
*/
async function loadTickets(){
  ticketsList.innerHTML = '<div class="empty">Загрузка заявок...</div>';
  try{
    let docs = [];

    // try collectionGroup first
    try{
      const snap = await db.collectionGroup('tickets').orderBy('createdAt','desc').get();
      if(snap && snap.size) docs = snap.docs;
      console.log('collectionGroup result size=', snap.size);
    }catch(e){
      console.warn('collectionGroup failed:', e);
      // if permission denied, show helpful message and stop
      if(e && e.code === 'permission-denied'){
        ticketsList.innerHTML = '<div class="error">Доступ к collectionGroup("tickets") запрещён (permission-denied). Проверьте правила Firestore.</div>';
        return;
      }
      // otherwise continue to try root collection
    }

    // fallback: root collection 'tickets'
    if(!docs.length){
      try{
        const snap2 = await db.collection('tickets').orderBy('createdAt','desc').get();
        if(snap2 && snap2.size) docs = snap2.docs;
        console.log('root tickets result size=', snap2.size);
      }catch(e2){
        console.warn('root tickets read failed:', e2);
        if(e2 && e2.code === 'permission-denied'){
          ticketsList.innerHTML = '<div class="error">Доступ к корневой коллекции "tickets" запрещён (permission-denied). Проверьте правила Firestore.</div>';
          return;
        }
      }
    }

    if(!docs.length){
      ticketsList.innerHTML = '<div class="empty">Заявок нет.</div>';
      return;
    }

    // render list
    ticketsList.innerHTML = '';
    docs.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement('div');
      div.className = 'ticket';
      const subj = data.subject || 'Без темы';
      const status = data.status || '—';
      const created = formatDate(data.createdAt);
      div.innerHTML = `<b>${escapeHtml(subj)}</b><div class="small">${escapeHtml(status)} · ${escapeHtml(created)}</div>`;
      div.onclick = ()=> openTicket(doc);
      ticketsList.appendChild(div);
    });

  }catch(e){
    console.error('loadTickets error', e);
    ticketsList.innerHTML = '<div class="error">Ошибка загрузки заявок. Смотрите консоль (Ctrl+Shift+J).</div>';
  }
}

/* open ticket — accepts either QueryDocumentSnapshot from collectionGroup or from root */
async function openTicket(doc){
  try{
    // doc may be QueryDocumentSnapshot; get latest snapshot from its ref
    const ref = doc.ref || doc; // doc could already be a DocumentReference (if you pass ref directly)
    const snap = await ref.get();
    if(!snap.exists){
      alert('Документ не найден');
      return;
    }
    const t = snap.data();
    currentTicketDocRef = ref;
    detailTitle.textContent = t.subject || 'Без темы';
    detailMeta.textContent = `${t.priority||''} · ${t.status||''} · ${formatDate(t.createdAt)}`;
    detailDesc.textContent = t.desc || '';
    renderComments(t.comments || []);
  }catch(e){
    console.error('openTicket error', e);
    alert('Ошибка открытия заявки — смотрите консоль.');
  }
}

function renderComments(arr){
  detailComments.innerHTML = '';
  if(!Array.isArray(arr) || !arr.length){
    detailComments.innerHTML = '<div class="empty">Комментариев нет</div>';
    return;
  }
  arr.forEach(c=>{
    const isStaff = c.role === 'staff';
    const div = document.createElement('div');
    div.className = 'comment' + (isStaff ? ' staff' : '');
    const by = escapeHtml(c.byName || 'Пользователь');
    const time = formatDate(c.at);
    const text = escapeHtml(c.text || '');
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${by} ${isStaff?'<span class="staff-label">Сотрудник поддержки</span>':''}</div><div class="small">${time}</div></div><div style="margin-top:6px">${text}</div>`;
    detailComments.appendChild(div);
  });
}

/* reply */
replyBtn.onclick = async ()=>{
  if(!currentTicketDocRef) return alert('Выберите заявку слева');
  const text = replyText.value.trim();
  if(!text) return;
  if(!currentUser) return alert('Войдите');

  const u = await db.collection('users').doc(currentUser.uid).get();
  const name = u.exists ? (u.data().name || currentUser.email) : currentUser.email;

  const comment = {
    text,
    by: currentUser.uid,
    byName: name,
    role: 'staff',
    at: new Date().toISOString()
  };
  try{
    await currentTicketDocRef.update({
      comments: firebase.firestore.FieldValue.arrayUnion(comment)
    });
    // refresh display: fetch doc again
    const fresh = await currentTicketDocRef.get();
    renderComments(fresh.data().comments || []);
    replyText.value = '';
  }catch(e){
    console.error('reply error', e);
    alert('Ошибка отправки ответа. Смотрите консоль.');
  }
};

/* small helper to escape html for safety in injected strings */
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[ch]);
}

/* initial */
ticketsList.innerHTML = '<div class="empty">Ожидание входа...</div>';
</script>
</body>
</html>
