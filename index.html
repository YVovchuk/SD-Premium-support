<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>SD Premium ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
--bg:#070507;--card:#0f0e10;--muted:#9b98a3;
--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);
--radius:14px;--shadow:0 6px 30px rgba(0,0,0,.6);
--green:#22c55e;--red:#ef4444;--blue:#3b82f6;
font-family:Inter;color-scheme:dark;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;padding:24px}
.wrap{max-width:1200px;margin:auto}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.logo{width:52px;height:52px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
.panel{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:16px}

.ticket{padding:12px;border-radius:10px;background:rgba(255,255,255,.03);margin-bottom:8px;cursor:pointer}
.ticket.new{border-left:4px solid #22c55e}
.ticket h4{margin:0 0 4px 0}

.small{font-size:13px;color:var(--muted)}
.btn{background:var(--accent);border:0;color:#fff;padding:8px 14px;border-radius:10px;font-weight:600;cursor:pointer}
.btn.red{background:#ef4444}
.btn.blue{background:#3b82f6}
.btn.gray{background:#151319;border:1px solid rgba(255,255,255,.08)}

input,textarea,select{background:#141217;border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:8px;padding:8px;width:100%}

.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#0f0f12;padding:18px;border-radius:14px;width:100%;max-width:400px}

.comment{background:rgba(255,255,255,.04);padding:8px;border-radius:8px;margin-bottom:6px}
.staff{color:#22c55e;font-weight:700}

.attach a{color:#3b82f6;text-decoration:none}

.status{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.05)}
</style>
</head>
<body>

<div class="wrap" id="app">
<div class="top">
<div style="display:flex;gap:12px;align-items:center">
<div class="logo">SD</div>
<div><b>SD Premium</b><div class="small">–ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div></div>
</div>
<div>
<span id="staffName">–ì–æ—Å—Ç—å</span>
<button id="loginBtn" class="btn gray">–í–æ–π—Ç–∏</button>
<button id="logoutBtn" class="btn gray" style="display:none">–í—ã–π—Ç–∏</button>
</div>
</div>

<div class="grid">
<div class="panel">
<input id="search" placeholder="–ü–æ–∏—Å–∫...">
<div id="ticketsList" style="margin-top:12px"></div>
</div>

<div class="panel">
<div id="empty"><div class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É</div></div>
<div id="ticketView" style="display:none">

<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h3 id="tvTitle"></h3>
<div class="small" id="tvUser"></div>
<div class="small" id="tvMeta"></div>
</div>
<div>
<select id="statusSelect">
<option>–ù–æ–≤–∞—è</option>
<option>–í —Ä–∞–±–æ—Ç–µ</option>
<option>–†–µ—à–µ–Ω–∞</option>
<option>–ê—Ä—Ö–∏–≤</option>
</select>
<button id="deleteBtn" class="btn red">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>

<div style="margin-top:12px">
<b>–û–ø–∏—Å–∞–Ω–∏–µ</b>
<div id="tvDesc" style="margin-top:6px"></div>
</div>

<div style="margin-top:12px">
<b>–í–ª–æ–∂–µ–Ω–∏—è</b>
<div id="tvAttach"></div>
</div>

<div style="margin-top:12px">
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</b>
<div id="tvComments"></div>
</div>

<textarea id="replyText" placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å..."></textarea>
<button id="sendReply" class="btn" style="margin-top:8px">–û—Ç–≤–µ—Ç–∏—Ç—å</button>

</div>
</div>
</div>

<div class="modal-backdrop" id="authModal">
<div class="modal">
<h3>–í—Ö–æ–¥</h3>
<input id="email" placeholder="Email">
<input id="pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button id="doLogin" class="btn">–í–æ–π—Ç–∏</button>
</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
authDomain:"sd-premium-b3b78.firebaseapp.com",
projectId:"sd-premium-b3b78"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const ticketsList=document.getElementById("ticketsList");
const ticketView=document.getElementById("ticketView");
const empty=document.getElementById("empty");

const tvTitle=document.getElementById("tvTitle");
const tvUser=document.getElementById("tvUser");
const tvMeta=document.getElementById("tvMeta");
const tvDesc=document.getElementById("tvDesc");
const tvComments=document.getElementById("tvComments");
const tvAttach=document.getElementById("tvAttach");

const replyText=document.getElementById("replyText");
const sendReply=document.getElementById("sendReply");
const statusSelect=document.getElementById("statusSelect");
const deleteBtn=document.getElementById("deleteBtn");

const authModal=document.getElementById("authModal");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const staffName=document.getElementById("staffName");

const email=document.getElementById("email");
const pass=document.getElementById("pass");
const doLogin=document.getElementById("doLogin");

let currentTicket=null;

loginBtn.onclick=()=>authModal.style.display="flex";
doLogin.onclick=()=>auth.signInWithEmailAndPassword(email.value,pass.value);
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async u=>{
if(u){
loginBtn.style.display="none";
logoutBtn.style.display="inline-block";
const doc=await db.collection("users").doc(u.uid).get();
staffName.textContent=doc.exists?doc.data().name:u.email;
loadTickets();
}else{
loginBtn.style.display="inline-block";
logoutBtn.style.display="none";
ticketsList.innerHTML="<div class='small'>–í–æ–π–¥–∏—Ç–µ</div>";
}
});

function loadTickets(){
db.collection("users").onSnapshot(async users=>{
ticketsList.innerHTML="";
for(const u of users.docs){
const uname=u.data().name||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
const snap=await db.collection("users").doc(u.id).collection("tickets").orderBy("createdAt","desc").get();
snap.forEach(d=>{
const t=d.data();
const div=document.createElement("div");
div.className="ticket "+(t.lastReplyRole==="user"?"new":"");
div.innerHTML=`<h4>${t.subject}</h4><div class="small">${uname} ¬∑ ${t.status||""}</div>`;
div.onclick=()=>openTicket(u.id,d.id,t,uname);
ticketsList.appendChild(div);
});
}
});
}

function openTicket(uid,id,t,uname){
currentTicket={uid,id};
ticketView.style.display="block";
empty.style.display="none";

tvTitle.textContent=t.subject;
tvUser.textContent="–û—Ç: "+uname;
tvMeta.textContent=t.status;
tvDesc.textContent=t.desc;

statusSelect.value=t.status||"–ù–æ–≤–∞—è";

tvComments.innerHTML="";
(t.comments||[]).forEach(c=>{
const div=document.createElement("div");
div.className="comment";
div.innerHTML=`<div class="small">${c.byName||"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"} ${c.role==="staff"?"<span class='staff'>(–ø–æ–¥–¥–µ—Ä–∂–∫–∞)</span>":""}</div><div>${c.text}</div>`;
tvComments.appendChild(div);
});

tvAttach.innerHTML="";
(t.attachments||[]).forEach(a=>{
const d=document.createElement("div");
d.className="attach";
d.innerHTML=`üìé <a href="${a.url}" target="_blank">${a.name}</a>`;
tvAttach.appendChild(d);
});
}

sendReply.onclick=async()=>{
if(!currentTicket) return;
const text=replyText.value.trim();
if(!text) return;
await db.collection("users").doc(currentTicket.uid).collection("tickets").doc(currentTicket.id).update({
comments:firebase.firestore.FieldValue.arrayUnion({
text,
at:new Date().toISOString(),
role:"staff",
byName:staffName.textContent
}),
lastReplyRole:"staff",
status:"–í —Ä–∞–±–æ—Ç–µ"
});
replyText.value="";
};

statusSelect.onchange=async()=>{
if(!currentTicket) return;
await db.collection("users").doc(currentTicket.uid).collection("tickets").doc(currentTicket.id).update({
status:statusSelect.value
});
};

deleteBtn.onclick=async()=>{
if(!currentTicket) return;
if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?"))return;
await db.collection("users").doc(currentTicket.uid).collection("tickets").doc(currentTicket.id).delete();
ticketView.style.display="none";
empty.style.display="block";
};
</script>
</body>
</html>
