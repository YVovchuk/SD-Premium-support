<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SD Premium ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
--bg:#070507;
--card:#0f0e10;
--muted:#9b98a3;
--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);
--ok:#22c55e;
--radius:14px;
--shadow:0 6px 30px rgba(2,2,6,.6);
font-family:Inter;
color-scheme:dark;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:var(--bg);color:#fff;display:flex;justify-content:center;padding:28px}
.wrap{max-width:1200px;width:100%}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.brand{display:flex;gap:14px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
.user{display:flex;gap:12px;align-items:center}
.avatar{width:42px;height:42px;border-radius:10px;background:#141217;border:1px solid rgba(255,255,255,.05);overflow:hidden}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.grid{display:grid;grid-template-columns:360px 1fr;gap:18px}
.btn{border:0;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer;background:var(--accent);color:#fff}
.btn.secondary{background:#151319;border:1px solid rgba(255,255,255,.08)}
.small{font-size:13px;color:var(--muted)}
.ticket{padding:12px;border-radius:12px;background:rgba(255,255,255,.03);margin-bottom:8px;cursor:pointer}
.ticket.active{outline:2px solid #8b5cf6}
.filters{display:flex;gap:8px;margin-bottom:10px}
select,input,textarea{
background:#141217;border:1px solid rgba(255,255,255,.08);
color:#fff;padding:8px;border-radius:8px;width:100%
}
.comment{background:rgba(255,255,255,.04);padding:10px;border-radius:10px;margin-bottom:8px}
.staff{color:var(--ok);font-weight:700}
.file-link{display:inline-block;margin-top:6px;color:#8b5cf6}
</style>
</head>
<body>

<div class="wrap">

<div class="topbar">
<div class="brand">
<div class="logo">SD</div>
<div>
<b>SD Premium</b>
<div class="small">–ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
</div>
</div>
<div class="user">
<div id="staffName">–ì–æ—Å—Ç—å</div>
<button id="loginBtn" class="btn secondary">–í–æ–π—Ç–∏</button>
<button id="logoutBtn" class="btn secondary" style="display:none">–í—ã–π—Ç–∏</button>
</div>
</div>

<div class="grid">
<div class="card">
<div class="filters">
<select id="statusFilter">
<option value="all">–í—Å–µ</option>
<option value="–ù–æ–≤–∞—è">–ù–æ–≤–∞—è</option>
<option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
<option value="–†–µ—à–µ–Ω–∞">–†–µ—à–µ–Ω–∞</option>
<option value="–ê—Ä—Ö–∏–≤">–ê—Ä—Ö–∏–≤</option>
</select>
<input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ –∏–ª–∏ –∏–º–µ–Ω–∏">
</div>
<div id="tickets"></div>
</div>

<div class="card">
<div id="emptyView" class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É —Å–ª–µ–≤–∞</div>
<div id="ticketView" style="display:none">
<h3 id="tSubject"></h3>
<div class="small" id="tMeta"></div>

<div style="margin-top:12px">
<strong>–û–ø–∏—Å–∞–Ω–∏–µ</strong>
<div id="tDesc" style="margin-top:6px"></div>
<div id="tFile"></div>
</div>

<div style="margin-top:14px">
<strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</strong>
<div id="comments"></div>
</div>

<div style="margin-top:12px">
<textarea id="replyText" placeholder="–û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏..."></textarea>
<input type="file" id="replyFile">
</div>

<div style="display:flex;gap:8px;margin-top:10px">
<select id="statusSelect">
<option>–ù–æ–≤–∞—è</option>
<option>–í —Ä–∞–±–æ—Ç–µ</option>
<option>–†–µ—à–µ–Ω–∞</option>
<option>–ê—Ä—Ö–∏–≤</option>
</select>
<button id="sendReply" class="btn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
<button id="deleteBtn" class="btn secondary">–£–¥–∞–ª–∏—Ç—å</button>
</div>
</div>
</div>
</div>

</div>

<script>
const firebaseConfig={
apiKey:"AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
authDomain:"sd-premium-b3b78.firebaseapp.com",
projectId:"sd-premium-b3b78"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const staffName=document.getElementById('staffName');
const ticketsEl=document.getElementById('tickets');
const emptyView=document.getElementById('emptyView');
const ticketView=document.getElementById('ticketView');
const tSubject=document.getElementById('tSubject');
const tMeta=document.getElementById('tMeta');
const tDesc=document.getElementById('tDesc');
const tFile=document.getElementById('tFile');
const commentsEl=document.getElementById('comments');
const replyText=document.getElementById('replyText');
const replyFile=document.getElementById('replyFile');
const sendReply=document.getElementById('sendReply');
const deleteBtn=document.getElementById('deleteBtn');
const statusSelect=document.getElementById('statusSelect');
const statusFilter=document.getElementById('statusFilter');
const search=document.getElementById('search');

let currentUser=null;
let staffDoc=null;
let allTickets=[];
let selected=null;

loginBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async u=>{
currentUser=u;
if(u){
loginBtn.style.display='none';
logoutBtn.style.display='inline-flex';
const doc=await db.collection('users').doc(u.uid).get();
staffDoc=doc.data();
if(!staffDoc?.isStaff){alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞");return;}
staffName.textContent=staffDoc.name||u.email;
loadTickets();
}else{
loginBtn.style.display='inline-flex';
logoutBtn.style.display='none';
staffName.textContent="–ì–æ—Å—Ç—å";
}
});

async function loadTickets(){
allTickets=[];
ticketsEl.innerHTML='';
const users=await db.collection('users').get();
for(const u of users.docs){
const userData=u.data();
const snap=await db.collection('users').doc(u.id).collection('tickets').get();
snap.forEach(d=>{
const t=d.data();
allTickets.push({
id:d.id,
uid:u.id,
subject:t.subject,
desc:t.desc,
status:t.status||'–ù–æ–≤–∞—è',
createdAt:t.createdAt,
comments:t.comments||[],
file:t.file||null,
userName:userData.name||'–ë–µ–∑ –∏–º–µ–Ω–∏',
userAvatar:userData.avatar||null
});
});
}
renderTickets();
}

function renderTickets(){
ticketsEl.innerHTML='';
const f=statusFilter.value;
const q=search.value.toLowerCase();
allTickets
.filter(t=>(f==='all'||t.status===f))
.filter(t=>t.subject.toLowerCase().includes(q)||t.userName.toLowerCase().includes(q))
.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt))
.forEach(t=>{
const d=document.createElement('div');
d.className='ticket'+(selected&&selected.id===t.id?' active':'');
d.innerHTML=`<b>${t.subject}</b>
<div class="small">${t.userName} ¬∑ ${t.status}</div>`;
d.onclick=()=>openTicket(t);
ticketsEl.appendChild(d);
});
}

function openTicket(t){
selected=t;
emptyView.style.display='none';
ticketView.style.display='block';
tSubject.textContent=t.subject;
tMeta.textContent=t.userName+" ¬∑ "+t.status;
tDesc.textContent=t.desc;
statusSelect.value=t.status;
renderComments(t.comments);
if(t.file){
tFile.innerHTML=`<a href="${t.file}" target="_blank" class="file-link">üìé –í–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>`;
}else tFile.innerHTML='';
renderTickets();
}

function renderComments(arr){
commentsEl.innerHTML='';
arr.forEach(c=>{
const d=document.createElement('div');
d.className='comment';
d.innerHTML=`
<div class="small">${c.byName||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ${c.role==='staff'?'<span class="staff">(–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏)</span>':''}</div>
<div>${c.text}</div>
${c.file?`<a href="${c.file}" target="_blank" class="file-link">üìé –í–ª–æ–∂–µ–Ω–∏–µ</a>`:''}
`;
commentsEl.appendChild(d);
});
}

sendReply.onclick=async()=>{
if(!selected)return;
let file=null;
if(replyFile.files[0]){
const r=new FileReader();
r.onload=async()=>{file=r.result;await sendComment(file)};
r.readAsDataURL(replyFile.files[0]);
}else await sendComment(null);
};

async function sendComment(file){
const ref=db.collection('users').doc(selected.uid).collection('tickets').doc(selected.id);
const c={
text:replyText.value,
at:new Date().toISOString(),
byName:staffDoc.name,
avatar:staffDoc.avatar||null,
role:'staff',
file:file
};
await ref.update({
comments:firebase.firestore.FieldValue.arrayUnion(c),
status:statusSelect.value
});
replyText.value='';
replyFile.value='';
loadTickets();
}

deleteBtn.onclick=async()=>{
if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?"))return;
await db.collection('users').doc(selected.uid).collection('tickets').doc(selected.id).delete();
ticketView.style.display='none';
emptyView.style.display='block';
loadTickets();
};

statusSelect.onchange=async()=>{
const ref=db.collection('users').doc(selected.uid).collection('tickets').doc(selected.id);
await ref.update({status:statusSelect.value});
loadTickets();
};

statusFilter.onchange=renderTickets;
search.oninput=renderTickets;
</script>
</body>
</html>
