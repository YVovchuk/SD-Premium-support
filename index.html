<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SD Premium ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>

  <!-- Google fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    /* === –í–ï–†–ù–£–¢ –î–ò–ó–ê–ô–ù (—Ç–æ—Ç —Å–∞–º—ã–π "—Ö–æ—Ä–æ—à–∏–π") === */
    :root{--bg:#070507;--card:#0f0e10;--muted:#9b98a3;--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);--radius:14px;--shadow:0 6px 30px rgba(2,2,6,.6);font-family:Inter,system-ui; color-scheme:dark;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:var(--bg);color:#fff;display:flex;justify-content:center;padding:28px}
    .container{max-width:1100px;width:100%}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
    .user{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:10px;background:#141217;border:1px solid rgba(255,255,255,.05);cursor:pointer;padding:0;overflow:hidden}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:var(--radius);padding:30px;box-shadow:var(--shadow);display:grid;grid-template-columns:1fr 360px;gap:20px}
    .actions{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    .btn{border:0;padding:12px 18px;border-radius:12px;font-weight:600;cursor:pointer;display:inline-flex;gap:8px;align-items:center;background:var(--accent);color:#fff;box-shadow:0 8px 24px rgba(139,92,246,.25)}
    .btn.secondary{background:#151319;box-shadow:none;border:1px solid rgba(255,255,255,.08)}
    .btn.sberpay{background:linear-gradient(90deg,#16a34a,#22c55e)}
    .panel{background:var(--card);border-radius:12px;padding:16px}
    .pill{background:rgba(255,255,255,.05);padding:8px 12px;border-radius:999px;font-weight:600}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:50}
    .modal{background:#0f0f12;border-radius:14px;padding:20px;width:100%;max-width:760px}
    .field{display:flex;flex-direction:column;margin-bottom:12px}
    .field input,.field textarea,.field select{background:#141217;border:1px solid rgba(255,255,255,.08);color:#fff;padding:10px;border-radius:8px}
    .muted{color:var(--muted);font-size:13px}
    .ticket-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px}
    .ticket-actions button{margin-left:8px}
    .small{font-size:13px;color:var(--muted)}
    /* toast */
    .toast-wrap{position:fixed;top:18px;right:18px;z-index:1000;display:flex;flex-direction:column;gap:8px}
    .toast{background:#111216;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.04);box-shadow:0 8px 30px rgba(0,0,0,.6);color:#fff;min-width:180px}
    .toast.success{border-left:4px solid #22c55e}
    /* confetti */
    .confetti{position:fixed;left:0;right:0;top:0;bottom:0;pointer-events:none;z-index:999}
    .confetti span{position:absolute;font-size:20px;animation:confetti 1200ms linear forwards}
    @keyframes confetti{from{transform:translateY(0) rotate(0) scale(1);opacity:1}to{transform:translateY(260px) rotate(520deg) scale(.8);opacity:0}}
  </style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand"><div class="logo">SD</div><div><b>SD Premium</b><div style="font-size:12px;color:var(--muted)">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div></div></div>
    <div class="user">
      <div><b id="topName">–ì–æ—Å—Ç—å</b><div style="font-size:12px;color:var(--muted)" id="accountStatus">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div></div>
      <button id="avatarBtn" class="avatar" title="–í–æ–π—Ç–∏"><img id="avatarImg" style="width:44px;height:44px;object-fit:cover" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" /></button>
      <button id="logoutBtn" class="btn secondary" style="display:none;margin-left:8px">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <main class="card">
    <section>
      <h2>–ü—Ä–∏–≤–µ—Ç, <span id="greetName">–ì–æ—Å—Ç—å</span></h2>
      <p class="muted">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SD Premium ‚Äî –ø–æ–º–æ–∂–µ–º –±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ.</p>
      <div class="actions">
        <button id="openRequest" class="btn">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        <button id="openMyTickets" class="btn">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
        <button id="openInstr" class="btn secondary">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
      </div>
    </section>
    <aside class="panel">
      <h3>–°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
      <div style="display:flex;gap:10px;align-items:center"><div class="pill" id="accountPlan">‚Äî</div><div class="pill">–ê–∫—Ç–∏–≤–Ω–æ: –¥–æ <span id="expiryDate">‚Äî</span></div></div>
      <button id="payBtn" class="btn" style="margin-top:12px">–û–ø–ª–∞—Ç–∏—Ç—å</button>
      <div id="instrPanel" style="display:none;margin-top:12px">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</strong>
        <ol style="padding-left:18px;margin:8px 0 0 0;line-height:1.6;" class="muted">
          <li>–í—Ö–æ–¥ ‚Äî —á–µ—Ä–µ–∑ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å.</li>
          <li>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ ‚Äî —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ, –º—ã –æ—Ç–≤–µ—Ç–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.</li>
          <li>–î–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç–º–µ—Ç—å—Ç–µ "–í—ã—Å–æ–∫–∏–π" –∏–ª–∏ "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π".</li>
        </ol>
      </div>
    </aside>
  </main>
</div>

<!-- Request Modal -->
<div class="modal-backdrop" id="requestModal"><div class="modal">
  <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h3>
  <form id="requestForm">
    <div class="field"><label>–¢–µ–º–∞</label><input id="subject" required></div>
    <div class="field"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label><select id="priority"><option>–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option><option>–í—ã—Å–æ–∫–∏–π</option><option>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option></select></div>
    <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="desc" required></textarea></div>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button type="button" class="btn secondary" id="requestCancel">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>
  </form>
</div></div>

<!-- Tickets Modal -->
<div class="modal-backdrop" id="ticketsModal"><div class="modal">
  <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
  <div style="margin-bottom:10px"><input id="ticketSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ –∏–ª–∏ ID" style="width:100%;padding:8px;border-radius:8px;background:#141217;border:1px solid rgba(255,255,255,.06);color:#fff"/></div>
  <div id="ticketsContainer" style="max-height:360px;overflow:auto"></div>
  <div style="text-align:right;margin-top:12px"><button class="btn secondary" id="closeTicketsBtn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Ticket Detail Modal -->
<div class="modal-backdrop" id="ticketModal"><div class="modal">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 id="ticketTitle">–ó–∞—è–≤–∫–∞</h3><div class="small" id="ticketId">#0</div></div>
  <div class="small" id="ticketMeta"></div>
  <div style="margin-top:12px"><strong>–û–ø–∏—Å–∞–Ω–∏–µ</strong><div id="ticketDesc" style="margin-top:6px;white-space:pre-wrap"></div></div>
  <div style="margin-top:12px"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</strong><div id="ticketComments" style="margin-top:6px"></div></div>
  <div style="margin-top:12px" class="field"><label>–î–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ</label><textarea id="newComment"></textarea></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
    <button id="addCommentBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ</button>
    <button id="cancelTicketBtn" class="btn secondary">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <button id="deleteTicketBtn" class="btn secondary">–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <button id="closeTicketModal" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</button>
  </div>
</div></div>

<!-- Profile Modal -->
<div class="modal-backdrop" id="profileModal"><div class="modal">
  <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
  <div class="field"><label>–ò–º—è</label><input id="profileName" /></div>
  <div class="field"><label>–ê–≤–∞—Ç–∞—Ä</label><input type="file" id="profileAvatar" accept="image/*" /></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn secondary" id="closeProfileBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    <button class="btn" id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

<!-- Login Modal -->
<div class="modal-backdrop" id="loginModal"><div class="modal" style="max-width:420px">
  <h3>–í—Ö–æ–¥</h3>
  <div class="field"><label>Email</label><input id="loginEmail" type="email" autocomplete="username"></div>
  <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input id="loginPassword" type="password" autocomplete="current-password"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
    <button class="btn secondary" id="openRegisterBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  </div>
</div></div>

<!-- Register Modal -->
<div class="modal-backdrop" id="registerModal"><div class="modal" style="max-width:420px">
  <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <div class="field"><label>–ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input id="registerName" required></div>
  <div class="field"><label>Email</label><input id="registerEmail" type="email"></div>
  <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input id="registerPassword" type="password"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" id="registerBtn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    <button class="btn secondary" id="openLoginBtn">–£ –º–µ–Ω—è –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
  </div>
</div></div>

<!-- Toast + confetti -->
<div class="toast-wrap" id="toastWrap"></div>
<div class="confetti" id="confetti"></div>

<script>
/* ====== FIREBASE CONFIG - –≤—Å—Ç–∞–≤—å —Å–≤–æ–π –ø—Ä–∏ –Ω–∞–¥–æ–±–Ω–æ—Å—Ç–∏ ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
  authDomain: "sd-premium-b3b78.firebaseapp.com",
  projectId: "sd-premium-b3b78",
  storageBucket: "sd-premium-b3b78.firebasestorage.app",
  messagingSenderId: "475471999638",
  appId: "1:475471999638:web:360d369103612e96f6c8b7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ====== UI refs ====== */
const requestModal = document.getElementById('requestModal');
const ticketsModal = document.getElementById('ticketsModal');
const ticketModal = document.getElementById('ticketModal');
const profileModal = document.getElementById('profileModal');
const loginModal = document.getElementById('loginModal');
const registerModal = document.getElementById('registerModal');

const avatarBtn = document.getElementById('avatarBtn');
const avatarImg = document.getElementById('avatarImg');
const topName = document.getElementById('topName');
const greetName = document.getElementById('greetName');
const accountStatus = document.getElementById('accountStatus');
const logoutBtn = document.getElementById('logoutBtn');

const openRequest = document.getElementById('openRequest');
const openMyTickets = document.getElementById('openMyTickets');
const openInstr = document.getElementById('openInstr');
const instrPanel = document.getElementById('instrPanel');
const payBtn = document.getElementById('payBtn');

const requestForm = document.getElementById('requestForm');
const requestCancel = document.getElementById('requestCancel');

const ticketsContainer = document.getElementById('ticketsContainer');
const ticketTitle = document.getElementById('ticketTitle');
const ticketIdEl = document.getElementById('ticketId');
const ticketMeta = document.getElementById('ticketMeta');
const ticketDesc = document.getElementById('ticketDesc');
const ticketComments = document.getElementById('ticketComments');
const newComment = document.getElementById('newComment');

const addCommentBtn = document.getElementById('addCommentBtn');
const cancelTicketBtn = document.getElementById('cancelTicketBtn');
const deleteTicketBtn = document.getElementById('deleteTicketBtn');
const closeTicketModal = document.getElementById('closeTicketModal');

const ticketSearch = document.getElementById('ticketSearch');
const closeTicketsBtn = document.getElementById('closeTicketsBtn');

const profileName = document.getElementById('profileName');
const profileAvatar = document.getElementById('profileAvatar');
const closeProfileBtn = document.getElementById('closeProfileBtn');
const saveProfileBtn = document.getElementById('saveProfileBtn');

const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const loginBtn = document.getElementById('loginBtn');
const openRegisterBtn = document.getElementById('openRegisterBtn');

const registerName = document.getElementById('registerName');
const registerEmail = document.getElementById('registerEmail');
const registerPassword = document.getElementById('registerPassword');
const registerBtn = document.getElementById('registerBtn');
const openLoginBtn = document.getElementById('openLoginBtn');

const expiryDateEl = document.getElementById('expiryDate');
const accountPlanEl = document.getElementById('accountPlan');

const toastWrap = document.getElementById('toastWrap');
const confettiWrap = document.getElementById('confetti');

/* ====== small helpers ====== */
function showModal(modal){ modal.style.display='flex'; document.querySelector('.container').classList?.add?.('blurred'); }
function hideModal(modal){ modal.style.display='none'; const visible = [...document.querySelectorAll('.modal-backdrop')].some(m=>m.style.display==='flex'); if(!visible) document.querySelector('.container').classList?.remove?.('blurred'); }
function showToast(text,type='info',timeout=3000){ const el=document.createElement('div'); el.className='toast '+(type==='success'?'success':''); el.textContent=text; toastWrap.appendChild(el); setTimeout(()=>{el.style.opacity='0'; setTimeout(()=>el.remove(),400)}, timeout); }
function createConfetti(){ const colors=['üéâ','‚ú®','‚≠ê','üéä','üí´']; for(let i=0;i<18;i++){ const s=document.createElement('span'); s.textContent=colors[Math.floor(Math.random()*colors.length)]; s.style.left=Math.random()*100+'%'; s.style.top=(-10-Math.random()*20)+'px'; s.style.fontSize=(12+Math.random()*18)+'px'; confettiWrap.appendChild(s); setTimeout(()=>s.remove(),1500); } }

/* ====== date formatting robust ====== */
function formatDMY(d){
  return String(d.getDate()).padStart(2,'0') + '.' + String(d.getMonth()+1).padStart(2,'0') + '.' + d.getFullYear();
}
function formatExpiry(exp){
  if(!exp) return '‚Äî';
  // Firestore Timestamp
  if(exp && typeof exp.toDate === 'function') return formatDMY(exp.toDate());
  if(typeof exp === 'string'){
    // already dd.mm.yyyy
    if(/^\d{2}\.\d{2}\.\d{4}$/.test(exp)) return exp;
    // ISO-like
    const d = new Date(exp);
    if(!isNaN(d)) return formatDMY(d);
    return exp;
  }
  if(exp instanceof Date) return formatDMY(exp);
  return String(exp);
}
function formatDate(ts){
  if(!ts) return '';
  if(ts && typeof ts.toDate === 'function') return ts.toDate().toLocaleString();
  const d = new Date(ts);
  if(!isNaN(d)) return d.toLocaleString();
  return String(ts);
}

/* ====== Auth & current state ====== */
let currentUser = null;
let currentTicketId = null;

auth.onAuthStateChanged(async user=>{
  currentUser = user;
  if(user){
    logoutBtn.style.display = 'inline-flex';
    // load profile doc
    try{
      const ud = await db.collection('users').doc(user.uid).get();
      const data = ud.exists ? ud.data() : {};
      topName.textContent = data.name || user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      greetName.textContent = data.name || user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      avatarImg.src = data.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
      accountStatus.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
      accountPlanEl.textContent = data.plan || '‚Äî';
      expiryDateEl.textContent = formatExpiry(data.expiry);
    }catch(e){
      console.error('read user doc', e);
    }
    enableAppForUser();
    renderTickets(); // load per-user tickets
  } else {
    // guest
    logoutBtn.style.display = 'none';
    topName.textContent = '–ì–æ—Å—Ç—å';
    greetName.textContent = '–ì–æ—Å—Ç—å';
    avatarImg.src = 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
    accountStatus.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
    accountPlanEl.textContent = '‚Äî';
    expiryDateEl.textContent = '‚Äî';
    disableAppForGuest();
    // do not force login modal here (user asked earlier, but keep optional): show login on avatar click
    // clear tickets view
    ticketsContainer.innerHTML = '<div class="small">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏</div>';
  }
});

/* login/register handling (separate modals) */
avatarBtn.onclick = ()=>{ if(currentUser){ profileName.value = topName.textContent; showModal(profileModal); } else { showModal(loginModal); } };

openRegisterBtn.onclick = ()=>{ hideModal(loginModal); showModal(registerModal); };
openLoginBtn.onclick = ()=>{ hideModal(registerModal); showModal(loginModal); };

loginBtn.onclick = async ()=>{
  const email = loginEmail.value.trim(), pass = loginPassword.value;
  if(!email || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
  try{ await auth.signInWithEmailAndPassword(email,pass); hideModal(loginModal); }catch(e){ alert(e.message); console.error(e); }
};

registerBtn.onclick = async ()=>{
  const name = registerName.value.trim();
  const email = registerEmail.value.trim();
  const pass = registerPassword.value;
  if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)');
  if(!email || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
  try{
    const uc = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(uc.user.uid).set({ name, avatar:null, expiry:null, payments:[] }, { merge:true });
    hideModal(registerModal);
    showToast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
  }catch(e){ alert(e.message); console.error(e); }
};

logoutBtn.onclick = async ()=>{ try{ await auth.signOut(); showToast('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); }catch(e){ alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: '+e.message); } };

/* profile save */
closeProfileBtn.onclick = ()=> hideModal(profileModal);
saveProfileBtn.onclick = async ()=>{
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
  const name = profileName.value.trim() || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  if(profileAvatar.files[0]){
    const reader = new FileReader();
    reader.onload = async ()=> {
      const avatarData = reader.result;
      await db.collection('users').doc(currentUser.uid).set({ name, avatar: avatarData }, { merge:true });
      topName.textContent = name; greetName.textContent = name; avatarImg.src = avatarData;
      hideModal(profileModal);
      showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω','success');
    };
    reader.readAsDataURL(profileAvatar.files[0]);
  } else {
    await db.collection('users').doc(currentUser.uid).set({ name }, { merge:true });
    topName.textContent = name; greetName.textContent = name;
    hideModal(profileModal);
    showToast('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω','success');
  }
};

/* enable/disable UI */
function enableAppForUser(){ avatarBtn.title = '–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'; }
function disableAppForGuest(){ avatarBtn.title = '–í–æ–π—Ç–∏'; }

/* ====== Tickets: strictly per-user (preferred subcollection), fallback filtered root ====== */
function userTicketsRef(){
  if(!currentUser) return null;
  return db.collection('users').doc(currentUser.uid).collection('tickets');
}
async function getTickets(){
  if(!currentUser) return [];
  // 1) try user subcollection
  try{
    const snap = await userTicketsRef().orderBy('createdAt','desc').get();
    if(snap && snap.size) return snap.docs.map(d=>({ id:d.id, ...d.data() }));
  }catch(e){
    console.warn('user subcollection read failed:', e);
  }
  // 2) fallback: root collection filtered by userId field
  try{
    const q = db.collection('tickets').where('userId','==', currentUser.uid).orderBy('createdAt','desc');
    const s = await q.get();
    if(s && s.size) return s.docs.map(d=>({ id:d.id, ...d.data() }));
  }catch(e){
    console.warn('root tickets where(userId) failed:', e);
  }
  // 3) fallback by email match
  try{
    const all = await db.collection('tickets').orderBy('createdAt','desc').get();
    const arr = all.docs.map(d=>({ id:d.id, ...d.data() }));
    const filtered = arr.filter(t=>{
      if(!t) return false;
      if(t.userId && t.userId===currentUser.uid) return true;
      if(t.email && currentUser.email && t.email.toLowerCase()===currentUser.email.toLowerCase()) return true;
      return false;
    });
    return filtered;
  }catch(e){
    console.error('tickets final fallback failed', e);
    return [];
  }
}

/* add/update/delete */
async function addTicketToDB(t){
  if(!currentUser){ showModal(loginModal); return; }
  // write to subcollection if possible, otherwise root with userId
  try{
    await userTicketsRef().add(t);
    return;
  }catch(e){
    // fallback
    t.userId = currentUser.uid;
    t.email = currentUser.email;
    await db.collection('tickets').add(t);
  }
}
async function updateTicketInDB(updated){
  if(!currentUser) return;
  const { id, ...data } = updated;
  // try subcollection update
  try{ await userTicketsRef().doc(id).update(data); return; }catch(e){ /* fallback */ }
  try{ await db.collection('tickets').doc(id).update(data); }catch(e){ console.warn('update fallback failed', e); }
}
async function deleteTicketFromDB(id){
  if(!currentUser) return;
  try{ await userTicketsRef().doc(id).delete(); return; }catch(e){}
  try{ await db.collection('tickets').doc(id).delete(); }catch(e){ console.warn('delete fallback failed', e); }
}

/* ====== Render tickets (per-user) ====== */
openRequest.onclick = ()=> { if(!currentUser) showModal(loginModal); else { showModal(requestModal); document.getElementById('subject').focus(); } };
requestCancel.onclick = ()=> hideModal(requestModal);

openMyTickets.onclick = async ()=>{ if(!currentUser){ showModal(loginModal); return; } await renderTickets(); showModal(ticketsModal); };
closeTicketsBtn.onclick = ()=> hideModal(ticketsModal);

openInstr.onclick = ()=> instrPanel.style.display = (instrPanel.style.display === 'none' || !instrPanel.style.display) ? 'block' : 'none';

async function renderTickets(filter){
  ticketsContainer.innerHTML = '';
  if(!currentUser){ ticketsContainer.innerHTML = '<div class="small">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏</div>'; return; }
  const arr = await getTickets();
  const q = (filter||'').toLowerCase();
  if(!arr.length){ ticketsContainer.innerHTML = '<div class="small">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>'; return; }
  arr.filter(t=> !q || (t.subject && t.subject.toLowerCase().includes(q)) || (t.id && t.id.toLowerCase().includes(q)) ).forEach(t=>{
    const row=document.createElement('div'); row.className='ticket-row';
    const left=document.createElement('div');
    const title=document.createElement('div');
    title.innerHTML = `<strong>#${t.id}</strong> ‚Äî ${t.subject} <div class="small">${t.priority || ''} ¬∑ ${t.status || ''} ¬∑ ${formatDate(t.createdAt)}</div>`;
    left.appendChild(title);
    const actions=document.createElement('div'); actions.className='ticket-actions';
    const openBtn=document.createElement('button'); openBtn.className='btn'; openBtn.textContent='–û—Ç–∫—Ä—ã—Ç—å'; openBtn.onclick=(ev)=>{ev.stopPropagation(); openTicket(t.id);};
    const delBtn=document.createElement('button'); delBtn.className='btn secondary'; delBtn.textContent='–£–¥–∞–ª–∏—Ç—å'; delBtn.onclick=(ev)=>{ ev.stopPropagation(); if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')){ deleteTicketFromDB(t.id).then(()=>renderTickets()); } };
    actions.appendChild(openBtn); actions.appendChild(delBtn);
    row.appendChild(left); row.appendChild(actions);
    row.onclick = ()=> openTicket(t.id);
    ticketsContainer.appendChild(row);
  });
}

/* open and show single ticket (reads from subcollection first) */
async function openTicket(id){
  hideModal(ticketsModal);
  // try subcollection doc
  let docSnap = null;
  try{
    docSnap = await userTicketsRef().doc(id).get();
    if(!docSnap.exists){
      // try root
      docSnap = await db.collection('tickets').doc(id).get();
    }
  }catch(e){
    try{ docSnap = await db.collection('tickets').doc(id).get(); }catch(e2){ console.error(e2); }
  }
  if(!docSnap || !docSnap.exists) { alert('–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
  const t = docSnap.data();
  currentTicketId = id;
  ticketTitle.textContent = t.subject || '';
  ticketIdEl.textContent = '#'+id;
  ticketMeta.textContent = `${t.priority || ''} ¬∑ ${t.status || ''} ¬∑ ${formatDate(t.createdAt)}`;
  ticketDesc.textContent = t.desc || '';
  renderComments(t.comments || []);
  newComment.value='';
  showModal(ticketModal);
}

function renderComments(comments){
  ticketComments.innerHTML = '';
  if(!Array.isArray(comments) || !comments.length){ ticketComments.innerHTML = '<div class="small">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</div>'; return; }
  comments.forEach(c=>{
    const d=document.createElement('div');
    d.style.padding='8px'; d.style.borderRadius='8px'; d.style.background='rgba(255,255,255,0.02)'; d.style.marginBottom='8px';
    const who = c.byName || c.by || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    const roleLabel = c.role === 'staff' ? ' <span style="color:#10b981;font-weight:600">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</span>' : '';
    d.innerHTML = `<div class="small">${escapeHtml(who)}${roleLabel} ¬∑ ${formatDate(c.at)}</div><div style="margin-top:6px">${escapeHtml(c.text)}</div>`;
    ticketComments.appendChild(d);
  });
}

/* add comment */
addCommentBtn.onclick = async ()=>{
  const text = newComment.value.trim(); if(!text) return;
  const arr = await getTickets(); const idx = arr.findIndex(x=>x.id===currentTicketId); if(idx===-1) return;
  if(!Array.isArray(arr[idx].comments)) arr[idx].comments = [];
  const comment = { text, at: new Date().toISOString(), by: currentUser?currentUser.uid:null, byName: currentUser? (currentUser.displayName || currentUser.email) : '–ì–æ—Å—Ç—å', role: 'user' };
  arr[idx].comments.push(comment);
  await updateTicketInDB(arr[idx]);
  renderComments(arr[idx].comments);
  newComment.value='';
};

/* cancel / delete */
cancelTicketBtn.onclick = async ()=>{ if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return; const arr = await getTickets(); const idx = arr.findIndex(x=>x.id===currentTicketId); if(idx===-1) return; arr[idx].status='–û—Ç–º–µ–Ω–µ–Ω–∞'; await updateTicketInDB(arr[idx]); ticketMeta.textContent = `${arr[idx].priority} ¬∑ ${arr[idx].status} ¬∑ ${formatDate(arr[idx].createdAt)}`; renderTickets(); };
deleteTicketBtn.onclick = async ()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ?')) return; await deleteTicketFromDB(currentTicketId); hideModal(ticketModal); renderTickets(); };
closeTicketModal.onclick = ()=> hideModal(ticketModal);

/* request submit -> write to per-user collection (preferred) */
requestForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!currentUser){ showModal(loginModal); return; }
  const subject = document.getElementById('subject').value.trim();
  const priority = document.getElementById('priority').value;
  const desc = document.getElementById('desc').value.trim();
  const ticket = { subject, priority, desc, createdAt: firebase.firestore.FieldValue.serverTimestamp(), status:'–ù–æ–≤–∞—è', comments:[], userId: currentUser.uid, email: currentUser.email };
  await addTicketToDB(ticket);
  // mailto fallback (keeps old behavior)
  const createdAt = new Date().toISOString();
  const body=[`Subject: ${subject}`,`Priority: ${priority}`,'',`Description:`,desc,'',`Date: ${createdAt}`].join('\n');
  window.location.href='mailto:sd@test.ru?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
  hideModal(requestModal);
  requestForm.reset();
  renderTickets();
});

/* ticket search */
ticketSearch.addEventListener('input', ()=> renderTickets(ticketSearch.value) );

/* small helpers */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g,ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[ch]); }

/* initial */
(function init(){
  // restore expiry from local if present
  const savedExpiry = localStorage.getItem('sd_expiry');
  if(savedExpiry) expiryDateEl.textContent = savedExpiry;
})();
</script>
</body>
</html>
