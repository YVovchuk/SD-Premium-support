<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>SD Premium ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
--bg:#070507;
--card:#0f0e10;
--muted:#9b98a3;
--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);
--ok:#22c55e;
--warn:#facc15;
--bad:#ef4444;
--radius:14px;
--shadow:0 6px 30px rgba(2,2,6,.6);
font-family:Inter,system-ui;
color-scheme:dark;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;padding:28px}
.container{max-width:1200px;margin:auto}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
.user{display:flex;gap:10px;align-items:center}
.btn{border:0;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer;background:var(--accent);color:#fff}
.btn.secondary{background:#151319;border:1px solid rgba(255,255,255,.08)}
.small{font-size:13px;color:var(--muted)}

.grid{display:grid;grid-template-columns:340px 1fr;gap:20px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:14px;padding:16px;box-shadow:var(--shadow)}

.ticket{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px;cursor:pointer}
.ticket.new{outline:2px solid var(--warn)}
.ticket.archived{opacity:.4}
.staff{color:var(--ok);font-weight:600}

textarea,input,select{background:#141217;border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:8px;padding:10px;width:100%}
.attach{display:block;color:#8b5cf6}
</style>
</head>
<body>

<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo">SD</div>
      <div>
        <b>SD Premium</b>
        <div class="small">–ü–∞–Ω–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
      </div>
    </div>
    <div class="user">
      <div>
        <b id="staffName">–ì–æ—Å—Ç—å</b>
        <div class="small" id="staffStatus">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
      </div>
      <button id="loginBtn" class="btn secondary">–í–æ–π—Ç–∏</button>
      <button id="logoutBtn" class="btn secondary" style="display:none">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <select id="statusFilter">
        <option value="all">–í—Å–µ</option>
        <option value="–ù–æ–≤–∞—è">–ù–æ–≤—ã–µ</option>
        <option value="–í —Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
        <option value="–ó–∞–∫—Ä—ã—Ç–∞">–ó–∞–∫—Ä—ã—Ç—ã–µ</option>
        <option value="–ê—Ä—Ö–∏–≤">–ê—Ä—Ö–∏–≤</option>
      </select>
      <input id="search" placeholder="–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫..." style="margin-top:8px">
      <div id="ticketsList" style="margin-top:12px"></div>
    </div>

    <div class="panel">
      <div id="emptyView" class="small">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É —Å–ª–µ–≤–∞</div>
      <div id="ticketView" style="display:none">
        <h3 id="tvTitle"></h3>
        <div class="small" id="tvMeta"></div>
        <p id="tvDesc"></p>

        <div id="tvAttach"></div>

        <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</strong>
        <div id="tvComments"></div>

        <textarea id="replyText" placeholder="–û—Ç–≤–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏..."></textarea>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="sendReply" class="btn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          <button onclick="setStatus('–í —Ä–∞–±–æ—Ç–µ')" class="btn secondary">–í —Ä–∞–±–æ—Ç—É</button>
          <button onclick="setStatus('–ó–∞–∫—Ä—ã—Ç–∞')" class="btn secondary">–ó–∞–∫—Ä—ã—Ç–∞</button>
          <button onclick="setStatus('–ê—Ä—Ö–∏–≤')" class="btn secondary">–ê—Ä—Ö–∏–≤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="authModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7)">
<div style="background:#0f0f12;padding:20px;border-radius:14px;width:320px">
<h3>–í—Ö–æ–¥</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button id="doLogin" class="btn" style="margin-top:10px">–í–æ–π—Ç–∏</button>
</div>
</div>

<script>
const firebaseConfig = {
apiKey:"AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
authDomain:"sd-premium-b3b78.firebaseapp.com",
projectId:"sd-premium-b3b78"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const staffName=document.getElementById('staffName');
const staffStatus=document.getElementById('staffStatus');
const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const authModal=document.getElementById('authModal');
const ticketsList=document.getElementById('ticketsList');
const statusFilter=document.getElementById('statusFilter');

loginBtn.onclick=()=>authModal.style.display='flex';
logoutBtn.onclick=()=>auth.signOut();
doLogin.onclick=async()=>{
await auth.signInWithEmailAndPassword(email.value,password.value);
authModal.style.display='none';
};

let currentUser=null;
let ticketsCache=[];
let selected=null;

auth.onAuthStateChanged(async user=>{
currentUser=user;
if(user){
loginBtn.style.display='none';
logoutBtn.style.display='inline-flex';
const doc=await db.collection('users').doc(user.uid).get();
if(!doc.data().isStaff){ alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞"); return; }
staffName.textContent=doc.data().name;
staffStatus.textContent="–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏";
loadTickets();
}else{
loginBtn.style.display='inline-flex';
logoutBtn.style.display='none';
}
});

async function loadTickets(){
ticketsCache=[];
ticketsList.innerHTML='';
const users=await db.collection('users').get();
for(const u of users.docs){
const snap=await db.collection('users').doc(u.id).collection('tickets').get();
snap.forEach(d=>{
const t=d.data();
t._uid=u.id;
t._id=d.id;
ticketsCache.push(t);
});
}
renderTickets();
}

function renderTickets(){
ticketsList.innerHTML='';
const q=search.value.toLowerCase();
const f=statusFilter.value;

ticketsCache
.filter(t=>(f==='all'||t.status===f))
.filter(t=>(!q||t.subject.toLowerCase().includes(q)))
.sort((a,b)=>(new Date(b.updatedAt||0)-new Date(a.updatedAt||0)))
.forEach(t=>{
const div=document.createElement('div');
div.className='ticket'+(t.hasNew?' new':'')+(t.status==='–ê—Ä—Ö–∏–≤'?' archived':'');
div.innerHTML=`<b>${t.subject}</b>
<div class="small">${t.status} ¬∑ ${t.priority}</div>
<div class="small">–û—Ç: ${t.userName}</div>`;
div.onclick=()=>openTicket(t);
ticketsList.appendChild(div);
});
}

function openTicket(t){
selected=t;
t.hasNew=false;
ticketView.style.display='block';
emptyView.style.display='none';
tvTitle.textContent=t.subject;
tvMeta.textContent=t.status+" ¬∑ "+t.priority;
tvDesc.textContent=t.desc;
tvAttach.innerHTML='';
if(t.attachments){
t.attachments.forEach(a=>{
const link=document.createElement('a');
link.href=a.data;
link.textContent="üìé "+a.name;
link.className="attach";
link.target="_blank";
tvAttach.appendChild(link);
});
}
renderComments(t.comments||[]);
renderTickets();
}

function renderComments(arr){
tvComments.innerHTML='';
arr.forEach(c=>{
const d=document.createElement('div');
d.innerHTML=`<div class="small"><b>${c.byName}</b> ${c.role==='staff'?'<span class="staff">(–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∫–∏)</span>':''}</div>
<div>${c.text}</div>`;
tvComments.appendChild(d);
});
}

sendReply.onclick=async()=>{
if(!selected)return;
const comment={text:replyText.value,byName:staffName.textContent,role:'staff',at:new Date().toISOString()};
selected.comments.push(comment);
selected.status="–í —Ä–∞–±–æ—Ç–µ";
selected.updatedAt=new Date().toISOString();
await db.collection('users').doc(selected._uid).collection('tickets').doc(selected._id).update({
comments:selected.comments,
status:selected.status,
updatedAt:selected.updatedAt
});
replyText.value='';
loadTickets();
};

function setStatus(s){
if(!selected)return;
selected.status=s;
selected.updatedAt=new Date().toISOString();
db.collection('users').doc(selected._uid).collection('tickets').doc(selected._id).update({
status:s,
updatedAt:selected.updatedAt
});
loadTickets();
}

search.oninput=statusFilter.onchange=renderTickets;
</script>
</body>
</html>
