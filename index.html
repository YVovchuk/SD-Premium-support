<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>SD Premium — Поддержка</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
:root{
--bg:#070507;
--card:#0f0e10;
--muted:#9b98a3;
--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);
--ok:#22c55e;
--radius:14px;
--shadow:0 6px 30px rgba(2,2,6,.6);
font-family:Inter,system-ui;
color-scheme:dark;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;padding:28px}
.container{max-width:1200px;margin:auto}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
.user{display:flex;gap:10px;align-items:center}
.btn{border:0;padding:10px 16px;border-radius:12px;font-weight:600;cursor:pointer;background:var(--accent);color:#fff}
.btn.secondary{background:#151319;border:1px solid rgba(255,255,255,.08)}

.grid{display:grid;grid-template-columns:340px 1fr;gap:20px}
.panel{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:14px;padding:16px;box-shadow:var(--shadow)}
.ticket{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px;cursor:pointer}
.ticket:hover{background:rgba(255,255,255,0.05)}
.small{font-size:13px;color:var(--muted)}
.staff{color:var(--ok);font-weight:600}
textarea,input{background:#141217;border:1px solid rgba(255,255,255,.08);color:#fff;border-radius:8px;padding:10px;width:100%}
</style>
</head>
<body>

<div class="container">
  <div class="topbar">
    <div class="brand">
      <div class="logo">SD</div>
      <div>
        <b>SD Premium</b>
        <div class="small">Панель поддержки</div>
      </div>
    </div>
    <div class="user">
      <div>
        <b id="staffName">Гость</b>
        <div class="small" id="staffStatus">Не авторизован</div>
      </div>
      <button id="loginBtn" class="btn secondary">Войти</button>
      <button id="logoutBtn" class="btn secondary" style="display:none">Выйти</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <input id="search" placeholder="Поиск заявок...">
      <div id="ticketsList" style="margin-top:12px"></div>
    </div>

    <div class="panel">
      <div id="emptyView" class="small">Выберите заявку слева</div>
      <div id="ticketView" style="display:none">
        <h3 id="tvTitle"></h3>
        <div class="small" id="tvMeta"></div>
        <p id="tvDesc"></p>

        <strong>Комментарии</strong>
        <div id="tvComments"></div>

        <textarea id="replyText" placeholder="Ответ поддержки..."></textarea>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="sendReply" class="btn">Ответить</button>
          <button id="markDone" class="btn secondary">Решена</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="authModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7)">
<div style="background:#0f0f12;padding:20px;border-radius:14px;width:320px">
<h3>Вход</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Пароль">
<button id="doLogin" class="btn" style="margin-top:10px">Войти</button>
</div>
</div>

<script>
const firebaseConfig = {
apiKey:"AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
authDomain:"sd-premium-b3b78.firebaseapp.com",
projectId:"sd-premium-b3b78"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const staffName=document.getElementById('staffName');
const staffStatus=document.getElementById('staffStatus');
const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const authModal=document.getElementById('authModal');

loginBtn.onclick=()=>authModal.style.display='flex';
logoutBtn.onclick=()=>auth.signOut();

document.getElementById('doLogin').onclick=async()=>{
await auth.signInWithEmailAndPassword(
document.getElementById('email').value,
document.getElementById('password').value
);
authModal.style.display='none';
};

let currentUser=null;
let selectedTicket=null;

auth.onAuthStateChanged(async user=>{
currentUser=user;
if(user){
loginBtn.style.display='none';
logoutBtn.style.display='inline-flex';
const doc=await db.collection('users').doc(user.uid).get();
if(!doc.exists||!doc.data().isStaff){
alert("Нет доступа");
return;
}
staffName.textContent=doc.data().name||user.email;
staffStatus.textContent="Сотрудник поддержки";
loadTickets();
}else{
staffName.textContent="Гость";
staffStatus.textContent="Не авторизован";
loginBtn.style.display='inline-flex';
logoutBtn.style.display='none';
}
});

async function loadTickets(){
const list=document.getElementById('ticketsList');
list.innerHTML='';
const users=await db.collection('users').get();
for(const u of users.docs){
const snap=await db.collection('users').doc(u.id).collection('tickets').get();
snap.forEach(d=>{
const t=d.data();
const el=document.createElement('div');
el.className='ticket';
el.innerHTML=`<b>${t.subject||'Без темы'}</b>
<div class="small">${t.status||''} · ${t.priority||''}</div>
<div class="small">От: ${t.userName||u.data().name||u.id}</div>`;
el.onclick=()=>openTicket(u.id,d.id,t);
list.appendChild(el);
});
}
}

function openTicket(uid,id,data){
selectedTicket={uid,id,data};
document.getElementById('emptyView').style.display='none';
document.getElementById('ticketView').style.display='block';
tvTitle.textContent=data.subject;
tvMeta.textContent=data.status+" · "+data.priority;
tvDesc.textContent=data.desc;
renderComments(data.comments||[]);
}

function renderComments(arr){
tvComments.innerHTML='';
arr.forEach(c=>{
const d=document.createElement('div');
d.className='small';
d.innerHTML=`<b>${c.byName||'Пользователь'}</b> ${c.role==='staff'?' <span class="staff">(Сотрудник поддержки)</span>':''}<br>${c.text}`;
tvComments.appendChild(d);
});
}

sendReply.onclick=async()=>{
if(!selectedTicket)return;
const text=replyText.value.trim();
if(!text)return;
const comment={
text,
at:new Date().toISOString(),
role:'staff',
byName:staffName.textContent
};
await db.collection('users')
.doc(selectedTicket.uid)
.collection('tickets')
.doc(selectedTicket.id)
.update({
comments:firebase.firestore.FieldValue.arrayUnion(comment),
status:"В работе"
});
replyText.value='';
loadTickets();
};

markDone.onclick=async()=>{
if(!selectedTicket)return;
await db.collection('users')
.doc(selectedTicket.uid)
.collection('tickets')
.doc(selectedTicket.id)
.update({status:"Решена"});
loadTickets();
};
</script>
</body>
</html>
