<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SD Premium — Панель поддержки</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    :root{--bg:#070507;--card:#0f0e10;--muted:#9b98a3;--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);--radius:12px;--shadow:0 8px 36px rgba(2,2,6,.6);--ok:#10b981;font-family:Inter,system-ui;color-scheme:dark}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:var(--bg);color:#fff;display:flex;justify-content:center;padding:28px}
    .wrap{max-width:1150px;width:100%}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
    .user{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:10px;background:#141217;border:1px solid rgba(255,255,255,.06);overflow:hidden}
    .panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .btn{background:var(--accent);border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#151319;border:1px solid rgba(255,255,255,.06)}
    .small{font-size:13px;color:var(--muted)}
    .tickets-list{max-height:70vh;overflow:auto;padding:8px}
    .ticket-item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px;cursor:pointer}
    .ticket-item h4{margin:0 0 6px 0}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1200}
    .modal{background:#0f0f12;padding:18px;border-radius:12px;width:100%;max-width:820px}
    .row{display:flex;gap:10px;align-items:center}
    .muted{color:var(--muted)}
    .staff-badge{color:var(--ok);font-weight:700;margin-left:8px}
    .error{color:#ff6b6b;background:rgba(255,107,107,0.06);padding:8px;border-radius:8px}
    .search{width:100%;padding:8px;border-radius:8px;background:#141217;border:1px solid rgba(255,255,255,.04);color:#fff}
  </style>
</head>
<body>
  <div class="wrap" id="mainWrap">
    <div class="top">
      <div class="brand"><div class="logo">SD</div><div><b>SD Premium</b><div class="small">Панель поддержки</div></div></div>
      <div class="user">
        <div style="text-align:right"><div id="staffName"><b>Гость</b></div><div class="small" id="staffStatus">Не авторизован</div></div>
        <button id="openLogin" class="btn secondary">Войти</button>
        <button id="logoutBtn" class="btn secondary" style="display:none;margin-left:8px">Выйти</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div><strong>Поиск заявок</strong><div class="small">искать по теме, id или email</div></div>
          <button id="refreshBtn" class="btn secondary">Обновить</button>
        </div>
        <input id="q" class="search" placeholder="Поиск...">
        <div class="tickets-list" id="ticketsList" style="margin-top:12px"></div>
      </div>

      <div class="panel" id="rightPanel">
        <div id="ticketViewEmpty"><h3 class="muted">Выберите заявку слева</h3></div>

        <div id="ticketView" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><h3 id="tvTitle" style="margin:0">—</h3><div class="small" id="tvMeta">—</div></div>
            <div><button id="markDone" class="btn">Отметить решённой</button></div>
          </div>

          <div style="margin-top:12px">
            <strong>Описание</strong>
            <div id="tvDesc" style="margin-top:8px;white-space:pre-wrap"></div>
          </div>

          <div style="margin-top:12px">
            <strong>Комментарии</strong>
            <div id="tvComments" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:12px">
            <div class="field"><label>Добавить ответ</label><textarea id="staffReply" style="width:100%;min-height:90px;background:#141217;border:1px solid rgba(255,255,255,.04);padding:10px;border-radius:8px;color:#fff"></textarea></div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
              <button id="sendReply" class="btn">Ответить как сотрудник</button>
              <button id="closeView" class="btn secondary">Закрыть</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Login/Register modal -->
  <div class="modal-backdrop" id="authModal"><div class="modal">
    <h3 id="authTitle">Вход / регистрация</h3>
    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <div class="field"><label>Email</label><input id="authEmail" type="email" style="width:100%;padding:8px;border-radius:8px;background:#141217;border:1px solid rgba(255,255,255,.04);color:#fff"></div>
        <div class="field"><label>Пароль</label><input id="authPass" type="password" style="width:100%;padding:8px;border-radius:8px;background:#141217;border:1px solid rgba(255,255,255,.04);color:#fff"></div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
      <button id="doLogin" class="btn">Войти</button>
      <button id="openRegister" class="btn secondary">Регистрация</button>
      <button id="authClose" class="btn secondary">Закрыть</button>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,.03);margin:12px 0">

    <div id="registerBlock" style="display:none">
      <div class="field"><label>Имя (обязательно)</label><input id="regName" style="width:100%;padding:8px;border-radius:8px;background:#141217;border:1px solid rgba(255,255,255,.04);color:#fff"></div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="regAsStaff" type="checkbox"><label for="regAsStaff" class="small">Зарегистрироваться как сотрудник (ВНИМАНИЕ: небезопасно в продакшн)</label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="doRegister" class="btn">Создать</button>
      </div>
    </div>

    <div id="authError" style="margin-top:8px;"></div>
  </div></div>

  <div class="modal-backdrop" id="loadingModal"><div class="modal"><div class="small">Загрузка...</div></div></div>

<script>
  /* ===== Firebase config - вставьте свой config при необходимости ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
    authDomain: "sd-premium-b3b78.firebaseapp.com",
    projectId: "sd-premium-b3b78",
    storageBucket: "sd-premium-b3b78.firebasestorage.app",
    messagingSenderId: "475471999638",
    appId: "1:475471999638:web:360d369103612e96f6c8b7"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI refs
  const mainWrap = document.getElementById('mainWrap');
  const openLogin = document.getElementById('openLogin');
  const logoutBtn = document.getElementById('logoutBtn');
  const staffNameEl = document.getElementById('staffName');
  const staffStatusEl = document.getElementById('staffStatus');
  const ticketsList = document.getElementById('ticketsList');
  const ticketsQuery = document.getElementById('q');
  const refreshBtn = document.getElementById('refreshBtn');

  const authModal = document.getElementById('authModal');
  const authEmail = document.getElementById('authEmail');
  const authPass = document.getElementById('authPass');
  const doLogin = document.getElementById('doLogin');
  const openRegister = document.getElementById('openRegister');
  const registerBlock = document.getElementById('registerBlock');
  const regName = document.getElementById('regName');
  const regAsStaff = document.getElementById('regAsStaff');
  const doRegister = document.getElementById('doRegister');
  const authClose = document.getElementById('authClose');
  const authError = document.getElementById('authError');
  const loadingModal = document.getElementById('loadingModal');

  const ticketView = document.getElementById('ticketView');
  const ticketViewEmpty = document.getElementById('ticketViewEmpty');
  const tvTitle = document.getElementById('tvTitle');
  const tvMeta = document.getElementById('tvMeta');
  const tvDesc = document.getElementById('tvDesc');
  const tvComments = document.getElementById('tvComments');
  const staffReply = document.getElementById('staffReply');
  const sendReply = document.getElementById('sendReply');
  const closeView = document.getElementById('closeView');
  const markDone = document.getElementById('markDone');

  let currentUser = null;
  let currentUserDoc = null;
  let selectedTicket = null; // {id, data, _path}

  function showModal(m){ m.style.display='flex'; mainWrap.classList.add('blurred'); }
  function hideModal(m){ m.style.display='none'; const visible = [...document.querySelectorAll('.modal-backdrop')].some(x=>x.style.display==='flex'); if(!visible) mainWrap.classList.remove('blurred'); }
  function showLoading(){ loadingModal.style.display='flex'; mainWrap.classList.add('blurred'); }
  function hideLoading(){ loadingModal.style.display='none'; const visible = [...document.querySelectorAll('.modal-backdrop')].some(x=>x.style.display==='flex'); if(!visible) mainWrap.classList.remove('blurred'); }
  function showError(msg){ authError.innerHTML = '<div class="error">'+msg+'</div>'; setTimeout(()=>authError.innerHTML='',5000); }

  openLogin.onclick = ()=> { authEmail.value=''; authPass.value=''; registerBlock.style.display='none'; showModal(authModal); }
  authClose.onclick = ()=> hideModal(authModal);
  openRegister.onclick = ()=> { registerBlock.style.display = registerBlock.style.display === 'none' ? 'block' : 'none'; };

  async function fetchUserDoc(uid){
    try{
      const s = await db.collection('users').doc(uid).get();
      return s.exists ? s.data() : null;
    }catch(e){ console.error('fetchUserDoc',e); return null; }
  }

  // --- Auth handlers ---
  doLogin.onclick = async ()=>{
    const email = authEmail.value.trim(), pass = authPass.value;
    if(!email || !pass) return showError('Введите email и пароль');
    try{
      showLoading();
      await auth.signInWithEmailAndPassword(email, pass);
      hideModal(authModal); hideLoading();
    }catch(e){ hideLoading(); showError(e.message); console.error(e); }
  };

  doRegister.onclick = async ()=>{
    const name = regName.value.trim(), email = authEmail.value.trim(), pass = authPass.value;
    if(!name) return showError('Введите имя');
    if(!email || !pass) return showError('Введите email и пароль');
    try{
      showLoading();
      const uc = await auth.createUserWithEmailAndPassword(email, pass);
      // WARNING: insecure in production to auto-assign staff
      const userDoc = { name, avatar:null, expiry:null, payments:[] };
      if(regAsStaff.checked) userDoc.isStaff = true; // developer note: remove in prod
      await db.collection('users').doc(uc.user.uid).set(userDoc, { merge:true });
      hideModal(authModal); hideLoading();
    }catch(e){ hideLoading(); showError(e.message); console.error(e); }
  };

  logoutBtn.onclick = async ()=> { try{ await auth.signOut(); showToast('Вы вышли'); }catch(e){ console.error(e); } };

  // toast
  function showToast(t){ const el=document.createElement('div'); el.className='toast success'; el.textContent=t; document.body.appendChild(el); setTimeout(()=>el.remove(),2500); }

  // --- On auth state change ---
  auth.onAuthStateChanged(async user=>{
    currentUser = user;
    if(user){
      logoutBtn.style.display='inline-flex';
      const doc = await fetchUserDoc(user.uid);
      currentUserDoc = doc || {};
      const displayName = (currentUserDoc && currentUserDoc.name) || user.email || 'Сотрудник';
      staffNameEl.innerHTML = '<b>'+escapeHtml(displayName)+'</b>';
      staffStatusEl.textContent = (currentUserDoc && currentUserDoc.isStaff) ? 'Сотрудник поддержки' : 'Авторизован (не сотрудник)';
      if(!(currentUserDoc && currentUserDoc.isStaff)){
        // show access denied overlay but still allow requesting access (or logging out)
        ticketsList.innerHTML = '<div class="error">Доступ запрещён: ваш аккаунт не помечен как сотрудник (users/{uid}.isStaff ≠ true)</div>';
        document.getElementById('rightPanel').style.display = 'none';
        return;
      } else {
        document.getElementById('rightPanel').style.display = 'block';
        await loadAllTickets();
      }
    } else {
      logoutBtn.style.display='none';
      staffNameEl.innerHTML = '<b>Гость</b>';
      staffStatusEl.textContent = 'Не авторизован';
      ticketsList.innerHTML = '<div class="small">Авторизуйтесь чтобы просматривать заявки</div>';
    }
  });

  // --- Fetch tickets: root + users subcollections ---
  async function loadAllTickets(){
    showLoading();
    try{
      ticketsList.innerHTML = '';
      const combined = [];
      // 1) root collection 'tickets'
      try{
        const snap = await db.collection('tickets').orderBy('createdAt','desc').get();
        snap.forEach(d=> combined.push({ id:d.id, ...d.data(), _source:'root' }));
      }catch(e){ console.warn('root tickets read failed', e); }

      // 2) iterate users and read their subcollections
      try{
        const usersSnap = await db.collection('users').get();
        for(const u of usersSnap.docs){
          const uid = u.id;
          try{
            const sub = await db.collection('users').doc(uid).collection('tickets').orderBy('createdAt','desc').get();
            sub.forEach(d=> combined.push({ id:d.id, ...d.data(), _source:`users/${uid}/tickets`, _ownerUid: uid }));
          }catch(e){ /* ignore per-user errors */ }
        }
      }catch(e){ console.warn('reading users list failed', e); }

      // normalize createdAt (may be timestamp)
      combined.forEach(t=>{
        if(t.createdAt && typeof t.createdAt.toDate === 'function') t._createdMs = t.createdAt.toDate().getTime();
        else if(typeof t.createdAt === 'string' || t.createdAt instanceof String) t._createdMs = new Date(t.createdAt).getTime();
        else if(t.createdAt instanceof Date) t._createdMs = t.createdAt.getTime();
        else t._createdMs = 0;
      });

      combined.sort((a,b)=> (b._createdMs||0) - (a._createdMs||0));

      if(!combined.length){
        ticketsList.innerHTML = '<div class="small">Заявок нет</div>';
        hideLoading();
        return;
      }

      for(const t of combined){
        const el = document.createElement('div');
        el.className='ticket-item';
        el.innerHTML = `<h4>${escapeHtml(t.subject||'Без темы')}</h4>
          <div class="small">${t.priority||''} · ${t.status||''} · ${formatDate(t.createdAt)} · ${t._source||''}</div>
          <div class="small">От: ${escapeHtml(t.email||t._ownerUid||'неизвестно')}</div>`;
        el.onclick = ()=> openTicketForStaff(t);
        ticketsList.appendChild(el);
      }
    }catch(e){
      ticketsList.innerHTML = '<div class="error">Ошибка загрузки заявок</div>';
      console.error(e);
    } finally{ hideLoading(); }
  }

  refreshBtn.onclick = ()=> loadAllTickets();

  // filter search
  ticketsQuery.addEventListener('input', async ()=> {
    // quick client-side filter by reloading and filtering DOM
    const q = ticketsQuery.value.trim().toLowerCase();
    Array.from(ticketsList.children).forEach(node=>{
      const txt = node.textContent.toLowerCase();
      node.style.display = txt.includes(q) ? '' : 'none';
    });
  });

  function openTicketForStaff(t){
    selectedTicket = t; // object includes _source
    ticketView.style.display = 'block';
    ticketViewEmpty.style.display = 'none';
    tvTitle.textContent = t.subject || '—';
    tvMeta.textContent = `${t.priority || ''} · ${t.status || ''} · ${formatDate(t.createdAt)} · ${t._source||''}`;
    tvDesc.textContent = t.desc || '';
    renderTicketComments(t.comments || []);
    staffReply.value = '';
  }

  function renderTicketComments(comments){
    tvComments.innerHTML = '';
    if(!Array.isArray(comments) || !comments.length){ tvComments.innerHTML = '<div class="small">Комментариев нет</div>'; return; }
    comments.forEach(c=>{
      const who = escapeHtml(c.byName || c.by || 'Пользователь');
      const time = formatDate(c.at);
      const isStaff = c.role === 'staff';
      const wrapper = document.createElement('div');
      wrapper.style.padding='8px'; wrapper.style.borderRadius='8px'; wrapper.style.background='rgba(255,255,255,0.02)'; wrapper.style.marginBottom='8px';
      wrapper.innerHTML = `<div class="small">${who}${isStaff ? '<span class="staff-badge"> — Сотрудник поддержки</span>' : ''} · ${time}</div>
        <div style="margin-top:6px">${escapeHtml(c.text)}</div>`;
      tvComments.appendChild(wrapper);
    });
  }

  // send reply as staff
  sendReply.onclick = async ()=>{
    if(!currentUser || !currentUserDoc || !currentUserDoc.isStaff) return alert('Нет доступа');
    const text = staffReply.value.trim();
    if(!text) return;
    const comment = { text, at: new Date().toISOString(), by: currentUser.uid, byName: currentUserDoc.name || currentUser.email, role: 'staff' };
    // determine where to update: if selectedTicket._source starts with 'users/' then update that document; else root
    try{
      showLoading();
      if(selectedTicket._source && selectedTicket._source.startsWith('users/')){
        // path like users/{uid}/tickets
        const ownerUid = selectedTicket._ownerUid;
        await db.collection('users').doc(ownerUid).collection('tickets').doc(selectedTicket.id).update({
          comments: firebase.firestore.FieldValue.arrayUnion(comment)
        });
      } else {
        await db.collection('tickets').doc(selectedTicket.id).update({
          comments: firebase.firestore.FieldValue.arrayUnion(comment)
        });
      }
      showToast('Ответ отправлен');
      // refresh view
      await loadAllTickets();
      // reopen the updated ticket (simple re-fetch)
      const refreshed = await findTicketById(selectedTicket.id);
      if(refreshed) openTicketForStaff(refreshed);
      staffReply.value = '';
    }catch(e){
      console.error('reply failed', e);
      alert('Ошибка отправки ответа: '+e.message);
    }finally{ hideLoading(); }
  };

  async function findTicketById(id){
    // try root
    try{ const s = await db.collection('tickets').doc(id).get(); if(s.exists) return { id:s.id, ...s.data(), _source:'root' }; }catch(e){}
    // try users/*/tickets
    try{
      const usersSnap = await db.collection('users').get();
      for(const u of usersSnap.docs){
        try{
          const doc = await db.collection('users').doc(u.id).collection('tickets').doc(id).get();
          if(doc.exists) return { id:doc.id, ...doc.data(), _source:`users/${u.id}/tickets`, _ownerUid:u.id };
        }catch(e){}
      }
    }catch(e){}
    return null;
  }

  // mark done
  markDone.onclick = async ()=>{
    if(!selectedTicket) return;
    if(!confirm('Отметить заявку как решённую?')) return;
    try{
      showLoading();
      const updateData = { status: 'Решена' };
      if(selectedTicket._source && selectedTicket._source.startsWith('users/')){
        await db.collection('users').doc(selectedTicket._ownerUid).collection('tickets').doc(selectedTicket.id).update(updateData);
      } else {
        await db.collection('tickets').doc(selectedTicket.id).update(updateData);
      }
      showToast('Статус обновлён');
      await loadAllTickets();
      const refreshed = await findTicketById(selectedTicket.id);
      if(refreshed) openTicketForStaff(refreshed);
    }catch(e){ console.error(e); alert('Не удалось обновить статус: '+e.message); } finally{ hideLoading(); }
  };

  closeView.onclick = ()=> { ticketView.style.display='none'; ticketViewEmpty.style.display='block'; selectedTicket = null; }

  // helper utilities
  function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g,ch=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[ch]); }
  function formatDate(ts){
    if(!ts) return '';
    if(typeof ts === 'object' && typeof ts.toDate === 'function') return ts.toDate().toLocaleString();
    if(typeof ts === 'string') {
      const d = new Date(ts);
      if(!isNaN(d)) return d.toLocaleString();
      return ts;
    }
    if(ts instanceof Date) return ts.toLocaleString();
    return String(ts);
  }

  // initial: hide loading
  hideLoading();

  // optional: auto-open auth on load if not logged in (commented out — enable if you want)
  // if(!auth.currentUser) openLogin.click();
</script>
</body>
</html>
