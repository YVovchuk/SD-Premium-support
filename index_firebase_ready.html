<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SD Premium ‚Äî –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#070507;--card:#0f0e10;--muted:#9b98a3;--accent:linear-gradient(90deg,#8b5cf6,#06b6d4);--radius:14px;--shadow:0 6px 30px rgba(2,2,6,.6);font-family:Inter,system-ui; color-scheme:dark;}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;background:var(--bg);color:#fff;display:flex;justify-content:center;padding:28px}
    .container{max-width:1100px;width:100%}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800}
    .user{display:flex;gap:12px;align-items:center}
    .avatar{width:44px;height:44px;border-radius:10px;background:#141217;border:1px solid rgba(255,255,255,.05);cursor:pointer;padding:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border-radius:var(--radius);padding:30px;box-shadow:var(--shadow);display:grid;grid-template-columns:1fr 360px;gap:20px}
    .actions{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    .btn{border:0;padding:12px 18px;border-radius:12px;font-weight:600;cursor:pointer;display:inline-flex;gap:8px;align-items:center;background:var(--accent);color:#fff;box-shadow:0 8px 24px rgba(139,92,246,.25)}
    .btn.secondary{background:#151319;box-shadow:none;border:1px solid rgba(255,255,255,.08)}
    .btn.sberpay{background:linear-gradient(90deg,#16a34a,#22c55e)}
    .panel{background:var(--card);border-radius:12px;padding:16px}
    .pill{background:rgba(255,255,255,.05);padding:8px 12px;border-radius:999px;font-weight:600}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:50}
    .modal{background:#0f0f12;border-radius:14px;padding:20px;width:100%;max-width:760px}
    .field{display:flex;flex-direction:column;margin-bottom:12px}
    .field input,.field textarea,.field select{background:#141217;border:1px solid rgba(255,255,255,.08);color:#fff;padding:10px;border-radius:8px}
    .muted{color:var(--muted);font-size:13px}
    .ticket-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px}
    .ticket-actions button{margin-left:8px}
    .small{font-size:13px;color:var(--muted)}
    /* toast */
    .toast-wrap{position:fixed;top:18px;right:18px;z-index:1000;display:flex;flex-direction:column;gap:8px}
    .toast{background:#111216;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.04);box-shadow:0 8px 30px rgba(0,0,0,.6);color:#fff;min-width:180px}
    .toast.success{border-left:4px solid #22c55e}
    /* confetti */
    .confetti{position:fixed;left:0;right:0;top:0;bottom:0;pointer-events:none;z-index:999}
    .confetti span{position:absolute;font-size:20px;animation:confetti 1200ms linear forwards}
    @keyframes confetti{from{transform:translateY(0) rotate(0) scale(1);opacity:1}to{transform:translateY(260px) rotate(520deg) scale(.8);opacity:0}}
  </style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand"><div class="logo">SD</div><div><b>SD Premium</b><div style="font-size:12px;color:var(--muted)">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div></div></div>
    <div class="user">
      <div><b id="topName">–Æ—Ä–∏–π</b><div style="font-size:12px;color:var(--muted)">–ü—Ä–µ–º–∏—É–º</div></div>
      <button id="avatarBtn" class="avatar"><img id="avatarImg" style="width:44px;height:44px;border-radius:10px;object-fit:cover;" /></button>
    </div>
  </div>

<!-- Profile Modal -->
<div class="modal-backdrop" id="profileModal"><div class="modal">
  <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
  <div class="field"><label>–ò–º—è</label><input id="profileName" /></div>
  <div class="field"><label>–ê–≤–∞—Ç–∞—Ä</label><input type="file" id="profileAvatar" accept="image/*" /></div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn secondary" id="closeProfileBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
    <button class="btn" id="saveProfileBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

  <main class="card">
    <section>
      <h2>–ü—Ä–∏–≤–µ—Ç, <span id="greetName">–Æ—Ä–∏–π</span></h2>
      <p class="muted">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SD Premium ‚Äî –ø–æ–º–æ–∂–µ–º –±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ—Å—Ç–æ.</p>
      <div class="actions">
        <button id="openRequest" class="btn">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
        <button id="openMyTickets" class="btn">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
        <button id="openInstr" class="btn secondary">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
      </div>
    </section>
    <aside class="panel">
      <h3>–°—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
      <div style="display:flex;gap:10px;align-items:center"><div class="pill">–ü—Ä–µ–º–∏—É–º</div><div class="pill">–ê–∫—Ç–∏–≤–Ω–æ: –¥–æ <span id="expiryDate">02.03.2026</span></div></div>
      <button id="payBtn" class="btn" style="margin-top:12px">–û–ø–ª–∞—Ç–∏—Ç—å</button>
      <div id="instrPanel" style="display:none;margin-top:12px">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</strong>
        <ol style="padding-left:18px;margin:8px 0 0 0;line-height:1.6;" class="muted">
          <li>–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å ‚Äî —á–µ—Ä–µ–∑ –≤–∞—à—É –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å.</li>
          <li>–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ ‚Äî —É–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ, –º—ã –æ—Ç–≤–µ—Ç–∏–º –≤ —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞.</li>
          <li>–î–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç–º–µ—Ç—å—Ç–µ "–í—ã—Å–æ–∫–∏–π".</li>
        </ol>
      </div>
    </aside>
  </main>
</div>

<!-- Request Modal -->
<div class="modal-backdrop" id="requestModal"><div class="modal">
  <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h3>
  <form id="requestForm">
    <div class="field"><label>–¢–µ–º–∞</label><input id="subject" required></div>
    <div class="field"><label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label><select id="priority"><option>–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option><option>–í—ã—Å–æ–∫–∏–π</option><option>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</option></select></div>
    <div class="field"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea id="desc" required></textarea></div>
    <div style="display:flex;gap:8px;justify-content:flex-end"><button type="button" class="btn secondary" id="requestCancel">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>
  </form>
</div></div>

<!-- Ticket Detail Modal -->
<div class="modal-backdrop" id="ticketModal"><div class="modal">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3 id="ticketTitle">–ó–∞—è–≤–∫–∞</h3><div class="small" id="ticketId">#0</div></div>
  <div class="small" id="ticketMeta"></div>
  <div style="margin-top:12px"><strong>–û–ø–∏—Å–∞–Ω–∏–µ</strong><div id="ticketDesc" style="margin-top:6px;white-space:pre-wrap"></div></div>
  <div style="margin-top:12px"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</strong><div id="ticketComments" style="margin-top:6px"></div></div>
  <div style="margin-top:12px" class="field"><label>–î–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ</label><textarea id="newComment"></textarea></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
    <button id="addCommentBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å —É—Ç–æ—á–Ω–µ–Ω–∏–µ</button>
    <button id="cancelTicketBtn" class="btn secondary">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <button id="deleteTicketBtn" class="btn secondary">–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <button id="closeTicketModal" class="btn secondary">–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ</button>
  </div>
</div></div>

<!-- My Tickets Modal -->
<div class="modal-backdrop" id="ticketsModal"><div class="modal">
  <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
  <div style="margin-bottom:10px"><input id="ticketSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ –∏–ª–∏ ID" style="width:100%;padding:8px;border-radius:8px;background:#141217;border:1px solid rgba(255,255,255,.06);color:#fff"/></div>
  <div id="ticketsContainer" style="max-height:360px;overflow:auto"></div>
  <div style="text-align:right;margin-top:12px"><button class="btn secondary" id="closeTicketsBtn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Payment Modal -->
<div class="modal-backdrop" id="paymentModal"><div class="modal">
  <h3>–û–ø–ª–∞—Ç–∞</h3>
  <div class="muted">–û–ø–ª–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Å–ø–æ—Å–æ–±–∞–º ‚Äî <strong id="priceLabel">499 ‚ÇΩ/–º–µ—Å</strong></div>
  <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
    <button id="payCardBtn" class="btn">–û–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π</button>
    <button id="sberpayBtn" class="btn sberpay">SberPay</button>
    <button id="sbpBtn" class="btn secondary">–°–ë–ü</button>
  </div>

  <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
    <label class="small">–ü–µ—Ä–∏–æ–¥</label>
    <select id="periodSelect" style="background:#141217;border:1px solid rgba(255,255,255,.06);padding:8px;border-radius:8px;color:#fff">
      <option value="1">1 –º–µ—Å—è—Ü</option>
      <option value="3">3 –º–µ—Å—è—Ü–∞</option>
      <option value="6">6 –º–µ—Å—è—Ü–µ–≤</option>
      <option value="12">12 –º–µ—Å—è—Ü–µ–≤</option>
    </select>
    <div style="margin-left:auto;text-align:right">
      <div class="small">–°—É–º–º–∞: <strong id="totalAmount">499 ‚ÇΩ</strong></div>
      <div class="small">–°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ: <span id="nextBilling">‚Äî</span></div>
      <div class="small" id="discountLabel"></div>
    </div>
  </div>

  <div id="cardForm" style="display:none;margin-top:12px">
    <form id="cardPaymentForm">
      <div class="field"><label>–ò–º—è –Ω–∞ –∫–∞—Ä—Ç–µ</label><input id="cardName" name="cardName" placeholder="IVAN IVANOV" required></div>
      <div class="field"><label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label><input id="cardNumber" name="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19" required></div>
      <div style="display:flex;gap:8px">
        <div class="field" style="flex:1"><label>–°—Ä–æ–∫</label><input id="cardExp" name="cardExp" placeholder="MM/YY" required></div>
        <div class="field" style="width:120px"><label>CVC</label><input id="cardCvc" name="cardCvc" placeholder="123" maxlength="4" required></div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button type="button" class="btn secondary" id="cancelCardPayment">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn">–û–ø–ª–∞—Ç–∏—Ç—å</button>
      </div>
    </form>
  </div>

  <div style="text-align:right;margin-top:14px"><button class="btn secondary" onclick="paymentModal.style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- toast + confetti -->
<div class="toast-wrap" id="toastWrap"></div>
<div class="confetti" id="confetti"></div>

<script>
const requestModal=document.getElementById('requestModal');
const profileModal=document.getElementById('profileModal');
const avatarBtn=document.getElementById('avatarBtn');
const avatarImg=document.getElementById('avatarImg');
const topName=document.getElementById('topName');
const greetName=document.getElementById('greetName');
const profileName=document.getElementById('profileName');
const profileAvatar=document.getElementById('profileAvatar');
const closeProfileBtn=document.getElementById('closeProfileBtn');
const saveProfileBtn=document.getElementById('saveProfileBtn');
const ticketModal=document.getElementById('ticketModal');
const ticketsModal=document.getElementById('ticketsModal');
const paymentModal=document.getElementById('paymentModal');
const openRequest=document.getElementById('openRequest');
const openMyTickets=document.getElementById('openMyTickets');
const openInstr=document.getElementById('openInstr');
const instrPanel=document.getElementById('instrPanel');
const payBtn=document.getElementById('payBtn');
const ticketsContainer=document.getElementById('ticketsContainer');
const expiryDateEl=document.getElementById('expiryDate');
const sberpayBtn=document.getElementById('sberpayBtn');
const sbpBtn=document.getElementById('sbpBtn');
const payCardBtn=document.getElementById('payCardBtn');
const requestForm=document.getElementById('requestForm');
const requestCancel=document.getElementById('requestCancel');
const cardForm=document.getElementById('cardForm');
const cardPaymentForm=document.getElementById('cardPaymentForm');
const cancelCardPayment=document.getElementById('cancelCardPayment');
const periodSelect=document.getElementById('periodSelect');
const totalAmount=document.getElementById('totalAmount');
const nextBilling=document.getElementById('nextBilling');
const discountLabel=document.getElementById('discountLabel');
const toastWrap=document.getElementById('toastWrap');
const confettiWrap=document.getElementById('confetti');

const ticketTitle=document.getElementById('ticketTitle');
const ticketIdEl=document.getElementById('ticketId');
const ticketMeta=document.getElementById('ticketMeta');
const ticketDesc=document.getElementById('ticketDesc');
const ticketComments=document.getElementById('ticketComments');
const newComment=document.getElementById('newComment');
const addCommentBtn=document.getElementById('addCommentBtn');
const cancelTicketBtn=document.getElementById('cancelTicketBtn');
const deleteTicketBtn=document.getElementById('deleteTicketBtn');
const closeTicketModal=document.getElementById('closeTicketModal');
const ticketSearch=document.getElementById('ticketSearch');
const closeTicketsBtn=document.getElementById('closeTicketsBtn');

const STORAGE_KEYS={tickets:'sd_tickets',expiry:'sd_expiry'};
const BASE_PRICE=499; // ‚ÇΩ per month
const DISCOUNTS={3:0.05,6:0.10,12:0.20};

async function getTickets(){const snap=await db.collection('tickets').orderBy('date','desc').get();return snap.docs.map(d=>d.data());}
async function saveTicket(ticket){await db.collection('tickets').add(ticket);}
function addTicket(t){const arr=getTickets();arr.unshift(t);saveTickets(arr)}
function updateTicket(updated){const arr=getTickets();const idx=arr.findIndex(x=>x.id===updated.id);if(idx!==-1){arr[idx]=updated;saveTickets(arr);} }
function deleteTicket(id){const arr=getTickets().filter(x=>x.id!==id);saveTickets(arr)}

function formatDate(iso){const d=new Date(iso);return d.toLocaleString()} 
function uid(){return 'T'+Date.now().toString(36).toUpperCase().slice(-8)}

function showToast(text,type='info',timeout=3000){const el=document.createElement('div');el.className='toast '+(type==='success'?'success':'');el.textContent=text;toastWrap.appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>el.remove(),400)},timeout)}
function createConfetti(){const colors=['üéâ','‚ú®','‚≠ê','üéä','üí´'];for(let i=0;i<18;i++){const s=document.createElement('span');s.textContent=colors[Math.floor(Math.random()*colors.length)];s.style.left=Math.random()*100+'%';s.style.top=(-10-Math.random()*20)+'px';s.style.fontSize=(12+Math.random()*18)+'px';confettiWrap.appendChild(s);setTimeout(()=>s.remove(),1500)} }

openRequest.onclick=()=>{requestModal.style.display='flex'; document.getElementById('subject').focus();}
requestCancel.onclick=()=>requestModal.style.display='none';
openMyTickets.onclick=()=>{renderTickets();ticketsModal.style.display='flex'}
openInstr.onclick=()=>instrPanel.style.display=instrPanel.style.display==='none'?'block':'none';
payBtn.onclick=()=>{paymentModal.style.display='flex';updatePaymentUI();}
closeTicketsBtn.onclick=()=>ticketsModal.style.display='none';

// profile handlers
avatarBtn.onclick=()=>{
  profileName.value=topName.textContent;
  profileModal.style.display='flex';
};
closeProfileBtn.onclick=()=>profileModal.style.display='none';
saveProfileBtn.onclick=()=>{
  const name=profileName.value.trim()||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
  topName.textContent=name;
  greetName.textContent=name;
  localStorage.setItem('sd_name',name);
  if(profileAvatar.files[0]){
    const reader=new FileReader();
    reader.onload=()=>{avatarImg.src=reader.result;localStorage.setItem('sd_avatar',reader.result);};
    reader.readAsDataURL(profileAvatar.files[0]);
  }
  profileModal.style.display='none';
};

requestForm.addEventListener('submit',e=>{
  e.preventDefault();
  const subject=document.getElementById('subject').value.trim();
  const priority=document.getElementById('priority').value;
  const desc=document.getElementById('desc').value.trim();
  const id=uid();
  const createdAt=new Date().toISOString();
  const ticket={id,subject,priority,desc,createdAt,status:'–ù–æ–≤–∞—è',comments:[]};
  addTicket(ticket);
  const body=[`Subject: ${subject}`,`Priority: ${priority}`,'',`Description:`,desc,'',`Date: ${createdAt}`].join('\n');
  window.location.href='mailto:sd@test.ru?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(body);
  requestModal.style.display='none';
  requestForm.reset();
});

function renderTickets(filter){
  const arr=getTickets();
  const q=(filter||'').toLowerCase();
  ticketsContainer.innerHTML='';
  if(!arr.length){ticketsContainer.innerHTML='<div class="small">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';return}
  arr.filter(t=>!q||t.subject.toLowerCase().includes(q)||t.id.toLowerCase().includes(q)).forEach(t=>{
    const row=document.createElement('div');row.className='ticket-row';
    const left=document.createElement('div');
    const title=document.createElement('div');title.innerHTML=`<strong>#${t.id}</strong> ‚Äî ${t.subject} <div class="small">${t.priority} ¬∑ ${t.status} ¬∑ ${formatDate(t.createdAt)}</div>`;
    left.appendChild(title);
    const actions=document.createElement('div');actions.className='ticket-actions';
    const openBtn=document.createElement('button');openBtn.className='btn';openBtn.textContent='–û—Ç–∫—Ä—ã—Ç—å';openBtn.onclick=()=>openTicket(t.id);
    const delBtn=document.createElement('button');delBtn.className='btn secondary';delBtn.textContent='–£–¥–∞–ª–∏—Ç—å';delBtn.onclick=(ev)=>{ev.stopPropagation(); if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')){deleteTicket(t.id);renderTickets();}}
    actions.appendChild(openBtn);actions.appendChild(delBtn);
    row.appendChild(left);row.appendChild(actions);
    row.onclick=()=>openTicket(t.id);
    ticketsContainer.appendChild(row);
  })
}

let currentTicketId=null;
function openTicket(id){
  ticketsModal.style.display='none';
  const arr=getTickets();
  const t=arr.find(x=>x.id===id);if(!t) return;currentTicketId=id;
  if(!Array.isArray(t.comments)) t.comments=[];
  ticketTitle.textContent=t.subject;
  ticketIdEl.textContent='#'+t.id;
  ticketMeta.textContent=`${t.priority} ¬∑ ${t.status} ¬∑ ${formatDate(t.createdAt)}`;
  ticketDesc.textContent=t.desc;
  renderComments(t.comments);
  newComment.value='';
  ticketModal.style.display='flex';
}

function renderComments(comments){
  ticketComments.innerHTML='';
  if(!Array.isArray(comments) || !comments.length){ticketComments.innerHTML='<div class="small">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç</div>';return}
  comments.forEach(c=>{
    const d=document.createElement('div');
    d.style.padding='8px';d.style.borderRadius='8px';d.style.background='rgba(255,255,255,0.02)';d.style.marginBottom='8px';
    d.innerHTML=`<div class="small">${formatDate(c.at)}</div><div style="margin-top:6px">${c.text}</div>`;
    ticketComments.appendChild(d)
  })
}

addCommentBtn.onclick=()=>{
  const text=newComment.value.trim();if(!text) return;
  const arr=getTickets();const idx=arr.findIndex(x=>x.id===currentTicketId);if(idx===-1) return;
  if(!Array.isArray(arr[idx].comments)) arr[idx].comments=[];
  const c={text,at:new Date().toISOString()};
  arr[idx].comments.push(c);updateTicket(arr[idx]);renderComments(arr[idx].comments);newComment.value='';
}

cancelTicketBtn.onclick=()=>{if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;const arr=getTickets();const idx=arr.findIndex(x=>x.id===currentTicketId);if(idx===-1) return;arr[idx].status='–û—Ç–º–µ–Ω–µ–Ω–∞';updateTicket(arr[idx]);ticketMeta.textContent=`${arr[idx].priority} ¬∑ ${arr[idx].status} ¬∑ ${formatDate(arr[idx].createdAt)}`;renderTickets();}

deleteTicketBtn.onclick=()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ?')) return;deleteTicket(currentTicketId);ticketModal.style.display='none';renderTickets();}

closeTicketModal.onclick=()=>ticketModal.style.display='none';

// payments helpers
function computeTotal(months){
  const base=BASE_PRICE*months;
  const disc=DISCOUNTS[months]||0;
  const total=Math.round(base*(1-disc));
  return {total,disc};
}
function parseExpiryDate(){const parts=expiryDateEl.textContent.split('.');return new Date(parts[2],parts[1]-1,parts[0])}
function formatDMY(date){return String(date.getDate()).padStart(2,'0')+'.'+String(date.getMonth()+1).padStart(2,'0')+'.'+date.getFullYear()}
function addMonthsToExpiry(months){const d=parseExpiryDate();d.setMonth(d.getMonth()+months);const newDate=formatDMY(d);expiryDateEl.textContent=newDate;localStorage.setItem(STORAGE_KEYS.expiry,newDate)}

// update UI for period
function updatePaymentUI(){
  const months=parseInt(periodSelect.value,10);
  const res=computeTotal(months);
  totalAmount.textContent=res.total+' ‚ÇΩ';
  if(res.disc>0){discountLabel.textContent='–°–∫–∏–¥–∫–∞: '+(res.disc*100)+'%';} else {discountLabel.textContent=''}
  const d=parseExpiryDate();d.setMonth(d.getMonth()+months);
  nextBilling.textContent=formatDMY(d);
}
periodSelect.addEventListener('change',updatePaymentUI);
updatePaymentUI();

// internal payment flow (card / sberpay / sbp) - do not open external apps
let currentPaymentMethod = null;
function showInternalPayment(method){
  currentPaymentMethod = method;
  // hide method buttons while entering payment details
  payCardBtn.style.display='none';
  sberpayBtn.style.display='none';
  sbpBtn.style.display='none';
  cardForm.style.display='block';
  updatePaymentUI();
}
function hideInternalPayment(){
  cardForm.style.display='none';
  payCardBtn.style.display='inline-flex';
  sberpayBtn.style.display='inline-flex';
  sbpBtn.style.display='inline-flex';
  currentPaymentMethod = null;
}

payCardBtn.onclick=()=>showInternalPayment('card');

// SberPay –∏ –°–ë–ü ‚Äî –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ —Å–∞–π—Ç—ã –∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∫–∞—Ä—Ç.
// –ù–∞–∂–∞—Ç–∏–µ —Å—Ä–∞–∑—É –ø—Ä–æ–≤–æ–¥–∏—Ç (—Å–∏–º—É–ª–∏—Ä—É–µ—Ç) –æ–ø–ª–∞—Ç—É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞.
sberpayBtn.onclick=()=>{
  const months=parseInt(periodSelect.value,10);
  const res=computeTotal(months);
  addMonthsToExpiry(months);
  paymentModal.style.display='none';
  showToast(`–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ SberPay –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ ‚Äî —Å–ø–∞—Å–∏–±–æ! (${res.total} ‚ÇΩ)`, 'success');
  createConfetti();
};

sbpBtn.onclick=()=>{
  const months=parseInt(periodSelect.value,10);
  const res=computeTotal(months);
  addMonthsToExpiry(months);
  paymentModal.style.display='none';
  showToast(`–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –°–ë–ü –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ ‚Äî —Å–ø–∞—Å–∏–±–æ! (${res.total} ‚ÇΩ)`, 'success');
  createConfetti();
};

cancelCardPayment.onclick=()=>{hideInternalPayment();}

cardPaymentForm.addEventListener('submit',e=>{
  e.preventDefault();
  const months=parseInt(periodSelect.value,10);
  paymentModal.style.display='none';
  addMonthsToExpiry(months);

  // method-specific toast
  if(currentPaymentMethod==='card'){
    showToast('–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ ‚Äî —Å–ø–∞—Å–∏–±–æ!', 'success');
  } else if(currentPaymentMethod==='sberpay'){
    showToast('–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ SberPay –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ ‚Äî —Å–ø–∞—Å–∏–±–æ!', 'success');
  } else if(currentPaymentMethod==='sbp'){
    showToast('–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –°–ë–ü –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ ‚Äî —Å–ø–∞—Å–∏–±–æ!', 'success');
  } else {
    showToast('–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ ‚Äî —Å–ø–∞—Å–∏–±–æ!', 'success');
  }

  createConfetti();
  cardPaymentForm.reset();
  hideInternalPayment();
});

function addMonthToExpiry(){addMonthsToExpiry(1)} // backward compat

const savedExpiry=localStorage.getItem(STORAGE_KEYS.expiry);if(savedExpiry)expiryDateEl.textContent=savedExpiry;

// search
ticketSearch.addEventListener('input',()=>renderTickets(ticketSearch.value));

const savedName=localStorage.getItem('sd_name');
if(savedName){topName.textContent=savedName;greetName.textContent=savedName;}
const savedAvatar=localStorage.getItem('sd_avatar');
if(savedAvatar){avatarImg.src=savedAvatar;} else {avatarImg.src='https://cdn-icons-png.flaticon.com/512/847/847969.png';}

(function init(){if(!localStorage.getItem(STORAGE_KEYS.tickets)){const sample=[{id:uid(),subject:'–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞—è–≤–∫–∞',priority:'–ù–æ—Ä–º–∞–ª—å–Ω—ã–π',desc:'–ü—Ä–∏–º–µ—Ä –æ–ø–∏—Å–∞–Ω–∏—è',createdAt:new Date().toISOString(),status:'–ù–æ–≤–∞—è',comments:[]}];saveTickets(sample)}renderTickets();})();
</script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyAoTaDDCB-TUZzSlRuUKvnQ8QcJPQdERFE",
  authDomain: "sd-premium-b3b78.firebaseapp.com",
  projectId: "sd-premium-b3b78",
  storageBucket: "sd-premium-b3b78.firebasestorage.app",
  messagingSenderId: "475471999638",
  appId: "1:475471999638:web:360d369103612e96f6c8b7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

</body>
</html>
